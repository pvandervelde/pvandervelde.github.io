
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Mind vortex - Swerve drive - Motor limitations</title>
        <meta name="description" content="Welcome!" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Mind vortex" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Mind vortex" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/normalize.css" rel="stylesheet" />
        <link href="/assets/css/h5bp.css" rel="stylesheet">
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
        <link href="/assets/css/override.css" rel="stylesheet" />
        <link href="/assets/css/github.css" rel="stylesheet" type="text/css">

        <script src="https://fred-wang.github.io/TeXZilla/TeXZilla-min.js"></script>
        <script src="https://fred-wang.github.io/TeXZilla/examples/customElement.js"></script>
        <link href="https://fred-wang.github.io/MathFonts/Asana/mathfonts.css" rel="stylesheet" />

        <meta name="application-name" content="Mind vortex" />
        <meta name="msapplication-tooltip" content="Mind vortex" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Mind vortex - Swerve drive - Motor limitations" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://www.petrikvandervelde.nl/posts/Swerve-drive-motor-limitations" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>
        <script src="/assets/js/highlight.pack.js"></script>
        <script src="/assets/js/clean-blog.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

        <!-- Our scripts -->
<script src="/assets/js/script.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DV643VJGFT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DV643VJGFT');
</script>


    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->
        <div id="header" class="container">
            <div id="logo">
                <h1><a href="/">Mind vortex</a></h1>
            </div>
            <div id="menu">
                <ul>
                            <!-- Pages -->
        <!-- BlogPosts -->
        <!-- Tags -->
        <!-- TagIndex -->
        <!-- BlogArchive -->
        <!-- Index -->
        <!-- RenderTagIndex -->
        <!-- RenderTags -->
        <!-- RenderBlogArchive -->
        <!-- Feed -->
        <!-- RenderBlogPosts -->
    <!-- Context.Documents['Pages'] -->
        <!-- 404 Not Found - False - /404 -->
        <!-- About - True - /about -->
        <!-- Projects - True - /projects -->
        <!-- Robotics - False - /projects/robotics -->
        <!-- Scuttle - False - /projects/scuttle -->
        <!-- Zinger - False - /projects/zinger -->
            <li class="inactive" >
                <a href="/">Home</a>
            </li>
            <li class="inactive" >
                <a href="/projects">Projects</a>
            </li>
            <li class="inactive" >
                <a href="/posts">Archive</a>
            </li>
            <li class="inactive" >
                <a href="/tags">Tags</a>
            </li>
            <li class="inactive" >
                <a href="/about">About</a>
            </li>

                </ul>
            </div>
        </div>

        <div id="page" class="container">
            <div id="sidebar">
                <div id="sbox1">
                    <h2>Patrick van der Velde</h2>

<p>
    <img src="https://www.gravatar.com/avatar/9bc8b3ff385cd14f2b12138c97729df2?s=160"
        alt="Gravatar for Patrick van der Velde">
</p>
<p>
    I am a senior lead software engineer who is living, working and playing in New Zealand.
    Developer of the <a href="/tags/Zinger">Zinger robot</a>, contributor on the
    <a href="/tags/Scuttle">Scuttle project</a>.

    In my spare time wood worker, rock climber, gardner.
</p>
<p>
    <a href="/about.html">More ...</a>
</p>

                </div>
                <div id="sbox2">
                    <h2>Recent</h2>
                    <ul class="list-unstyled">
                            <li><a href="/posts/Swerve-drive-motor-limitations">Swerve drive - Motor limitations</a></li>
                            <li><a href="/posts/Swerve-drive-ros2-nav">Swerve drive - Using Nav2</a></li>
                            <li><a href="/posts/Robotics-making-urdf-models">Robotics - Making URDF models</a></li>
                            <li><a href="/posts/Swerve-motion-profiles">Swerve drive - Motion profiles</a></li>
                            <li><a href="/posts/Swerve-drive-control-animations">Swerve drive - Movement animations</a></li>
                            <li><a href="/posts/Swerve-drive-body-focussed-control">Swerve drive - Better movement by controlling the body motions</a></li>
                            <li><a href="/posts/Swerve-drive-kinematics-verification">Swerve drive - Verification of the kinematics solution</a></li>
                            <li><a href="/posts/Swerve-drive-kinematics-simulation">Swerve drive - Kinematics simulation</a></li>
                            <li><a href="/posts/Swerve-drive-introduction">Swerve drive - Moving a robot in all directions, mostly</a></li>
                            <li><a href="/posts/Robotics-fixing-scuttles-encoder">Starting robotics - Fixing the wheel encoders</a></li>
                    </ul>
                </div>
                <div id="sbox3">
                    <h2>Tags</h2>
                    <div>
                        <ul class="list-unstyled">
                                <li>
                                    <a role="button" href="/tags/Robotics" class="btn btn-default btn-sm"> Robotics (17)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Sherlock" class="btn btn-default btn-sm"> Sherlock (13)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/nBuildKit" class="btn btn-default btn-sm"> nBuildKit (12)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Software-development-pipeline" class="btn btn-default btn-sm"> Software development pipeline (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Delivering-software" class="btn btn-default btn-sm"> Delivering software (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/DevOps" class="btn btn-default btn-sm"> DevOps (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/PG2" class="btn btn-default btn-sm"> PG2 (9)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Paragliding" class="btn btn-default btn-sm"> Paragliding (9)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Zinger" class="btn btn-default btn-sm"> Zinger (8)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Omnidirectional" class="btn btn-default btn-sm"> Omnidirectional (8)</a>
                                </li>
                        </ul>
                    </div>
                    <br />
                    <ul class="pager">
                        <li class="next">
                            <a href="/tags">View All Tags &rarr;</a>
                        </li>
                    </ul>
                </div>
            </div>

            <div id="content">

<div id="post">
    <div id="post-header">
        <!--
    Model is: Tuple<IDocument, IDocument>.
    The first one is the current document that is being rendered, the second one is the one for which the post header should be rendered.
-->


<h2>
Swerve drive - Motor limitations</h2>
<div id="post-meta">
    <div class="meta-date">
Thursday, February 22, 2024
 |             Posted in     </div>
    <div class="meta-tags">
                        <a id="post-category" role="button" href="/tags/Kinematics" class="btn btn-default btn-xs tag-no-wrap">Kinematics</a>
                        <a id="post-category" role="button" href="/tags/Omnidirectional" class="btn btn-default btn-xs tag-no-wrap">Omnidirectional</a>
                        <a id="post-category" role="button" href="/tags/Robotics" class="btn btn-default btn-xs tag-no-wrap">Robotics</a>
                        <a id="post-category" role="button" href="/tags/Swerve" class="btn btn-default btn-xs tag-no-wrap">Swerve</a>
    </div>
</div>

    </div>

    <div id="post-content">
        <p>The <a href="/posts/Swerve-drive-kinematics-simulation">swerve controller</a> I have implemented so far assumes
that the robot is able to follow all the movement commands it has been given. This can lead to extreme
velocity and acceleration for the drive and steering motors. The image below shows the result of a
simulation where the robot is commanded to move in a straight line followed by a rotate in-place. The
simulation used a s-curve <a href="/posts/Swerve-motion-profiles">motion profile</a> to generate a smooth body
movement between different states. The graphs show that the drive velocity and acceleration are
smooth and don't reach very high values. It is thus expected that these are well within the
capabilities of the drive motors. The steering velocity and acceleration show significant peaks which
are likely to tax the steering motors.</p>
<figure style="float:left">
  <a href="/assets/images/robotics/control/inplace_rotation_from_0_fwd_unlimited.png" target="_blank">
    <img
        alt="The positions, velocities and accelerations of the robot and the drive modules as it moves in a straight line and then rotates in place with no limiters applied."
        src="/assets/images/robotics/control/inplace_rotation_from_0_fwd_unlimited.png"
        width="416"
        height="200"/>
  </a>
  <figcaption>
    The positions, velocities and accelerations of the robot and the drive modules as it moves in a
    straight line and then rotates in place. No limitations were applied to the steering and drive
    velocities and accelerations.
  </figcaption>
</figure>
<p>In order to ensure that the motors are able to follow the movement commands while keeping the motions
of the different drive modules <a href="/posts/Swerve-drive-body-focussed-control">synchronised</a>, we need to
take into account the capabilities of the motors.</p>
<p>Now there are many different motor characteristics that we could take into account. For instance:</p>
<ul>
<li>The maximum velocity the motor can achieve. This obviously limits how fast the drive module can steer
or rotate the wheels.</li>
<li>The maximum acceleration the motor can achieve. This limits how fast the drive module can change the
drive or steering velocity and thus how quickly it can respond to command changes.</li>
<li>The maximum jerk the motor can achieve. This limits how quickly the motor can achieve the desired
acceleration.</li>
<li>The existence of any motor <a href="https://en.wikipedia.org/wiki/Deadband">deadband</a>. This is the region
around zero rotation speed where the motor doesn't have enough torque to overcome the static
friction of the motor and attached systems. Once enough torque is applied the motor will start
running at the rotation speed that it would normally have for that amount of torque. This means that
there is a minimum rotation speed that the motor can achieve.</li>
<li>The behaviour of the motor under load. For instance the motor may not be able to reach the desired
rotation speed under load.</li>
<li>The motor settling time, which is the time it takes the motor to reach the commanded speed.</li>
<li>The behaviour of the motor when running &lsquo;forwards&rsquo; versus when running 'backwards'. For
instance the motor may have a different maximum velocity in the &lsquo;forward&rsquo; direction than it does
in the 'backwards' direction.</li>
</ul>
<p>At the moment I will only be looking at the maximum motor velocities and the accelerations. These two
have a direct effect on the synchronisation between the drive modules. The other characteristics will
be dealt at a later stage as they require more information and thought.</p>
<p>In order to limit the steering and drive velocities I've implemented the following process</p>
<ol>
<li><a href="https://github.com/pvandervelde/basic-swerve-sim/blob/d6c8349b7f184c85ac77fa8b19298bb79e22cebf/swerve_controller/control_profile.py#L612">Determine</a>
the body movement profile that allows the body to achieve the desired movement state in
a smooth manner using <a href="/posts/Swerve-motion-profiles">s-curve motion profiles</a>.</li>
<li>Divide the body movement profiles into N+1 points, dividing the profile into N sections of equal
time. For each of these points
<a href="https://github.com/pvandervelde/basic-swerve-sim/blob/d6c8349b7f184c85ac77fa8b19298bb79e22cebf/swerve_controller/control_profile.py#L635">calculate the velocity and steering angle</a>
for the drive modules. These velocities and steering angles then form the motion profiles for each
of the drive modules.</li>
<li>For each point in time check the steering velocity for each module. Record the maximum velocity of
all the profiles. If the maximum velocity is larger than what the motor can deliver then
<a href="https://github.com/pvandervelde/basic-swerve-sim/blob/d6c8349b7f184c85ac77fa8b19298bb79e22cebf/swerve_controller/control_profile.py#L414">increase or decrease the current timestep</a>
in order to limit the steering velocity to the maximum velocity of the motor. Changing the
duration of the timestep will change the steering velocities of all the modules. Thus we limit
the steering velocities while maintaining synchronisation between the modules.</li>
<li>Repeat the previous step for the <a href="https://github.com/pvandervelde/basic-swerve-sim/blob/d6c8349b7f184c85ac77fa8b19298bb79e22cebf/swerve_controller/control_profile.py#L546">drive velocities</a>.</li>
</ol>
<p>The following video shows the result of the simulation using the new velocity limiter code. The video
shows the robot moving in a straight line and then rotating in place. When the rotation starts the
steering velocity for the different drive modules increases. As the steering velocity reaches 2 rad/s
for the left front and left rear modules the limiter kicks in and maintains that steering velocity.
In response the steering velocities of the other wheels reduces in order to keep the drive modules
synchronised. The wheel velocities are slightly altered.</p>
<iframe
    style="float:none"
    width="560"
    height="315"
    src="https://www.youtube.com/embed/H7HTa4b6f_0"
    title="YouTube video player"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
    allowfullscreen>
</iframe>
<p>With the steering and wheel velocities limited in a reasonable way I attempted to do the same for the
steering acceleration. The results of this can be seen in the next images. The first image limits the
steering acceleration to 15 rad/s^2. The second image limits the steering acceleration to 10 rad/s^2.</p>
<figure style="float:left">
  <a href="/assets/images/robotics/control/inplace_rotation_from_0_fwd_acc_limited_15_rad_s2.png" target="_blank">
    <img
        alt="The positions, velocities and accelerations of the robot and the drive modules as it moves in a straight line and then rotates in place. Limits are applied to the velocities and the steering acceleration."
        src="/assets/images/robotics/control/inplace_rotation_from_0_fwd_acc_limited_15_rad_s2.png"
        width="416"
        height="200"/>
  </a>
  <figcaption>
    The positions, velocities and accelerations of the robot and the drive modules as it moves in a
    straight line and then rotates in place. The steering velocity is limited to 2 rad/s, the drive
    velocity is limited to 1.0 m/s and the steering acceleration is limited to 15 rad/s^2.
  </figcaption>
</figure>
<figure style="float:left">
  <a href="/assets/images/robotics/control/inplace_rotation_from_0_fwd_acc_limited_10_rad_s2.png" target="_blank">
    <img
        alt="The positions, velocities and accelerations of the robot and the drive modules as it moves in a straight line and then rotates in place. Limits are applied to the velocities and the steering acceleration."
        src="/assets/images/robotics/control/inplace_rotation_from_0_fwd_acc_limited_10_rad_s2.png"
        width="416"
        height="200"/>
  </a>
  <figcaption>
    The positions, velocities and accelerations of the robot and the drive modules as it moves in a
    straight line and then rotates in place. The steering velocity is limited to 2 rad/s, the drive
    velocity is limited to 1.0 m/s and the steering acceleration is limited to 10 rad/s^2.
  </figcaption>
</figure>
<p>When comparing the two simulation results it becomes clear that something happens if we limit the
steering acceleration to 10 rad/s^2. The velocities over all for both cases looks reasonable, except
for the 10 rad/s^2 case where the steering velocity snaps to zero at the end of the transition from
the straight line to the rotation. This is reflected in a momentary acceleration of over 100 rad/s^2.</p>
<p>The acceleration is calculated based on the difference between the velocity at the current timestep
and the velocity at the previous timestep. Additionally the algorithm has to ensure that the steering
angle change between the previous and current timestep is controlled so that synchronisation of the
drive modules is maintained. Generally to limit the velocity the duration of the timestep is increased.
However for the acceleration, especially when decelerating from a positive velocity, there is a limit
to how much the timestep can be increased. A larger time step increase decreases the velocity. This
then increases the deceleration needed. So this means that you get very large timesteps, or very small
timesteps. The current algorithm favours small timesteps.</p>
<p>In either case the problem occurs when slowing down. At the end of the deceleration profile the desired
position is achieved, but the velocity and acceleration are not zero. This is not realistic or physically
possible. This behaviour is possibly due to the fact that the timesteps are individually calculated.
This means that the algorithm doesn't know what the desired end states are and so those are not taken
into account.</p>
<p>Additionally if we look at this approach from a higher level we can see that there are two potential
areas where improvements can be made in the control model. The first area is related to the fact that
the steering velocity and acceleration are computed values, i.e. they are derived from the change in
the steering position. This means that there is no direct control over the steering velocity and
acceleration. A better algorithm would include these values directly and be able to apply boundary
conditions on these values. This could be achieved by extending the current kinematic model with the
body accelerations and <a href="https://en.wikipedia.org/wiki/Jerk_(physics)">jerks</a>.
The second area is related tot the fact that the module states are derived from the body state. This
is necessary to keep the modules synchronised with the body. However this means that the module states
are not directly controlled. Which means that it is more difficult to include the module limitations
in the control model.</p>
<p>These issues will only become more pronounced if we want to start limiting the maximum jerk
values for the steering and drive directions. Limiting the maximum jerk is required to prevent excessive
forces on the drive module components.</p>
<p>One possible solution to these issues is to switch to a dynamic model for the control of the robot,
i.e. one that is based on the forces and accelerations observed by the robot as it moves.
The current model is a kinematic model, i.e. based on the positions and velocities of the different
components. Using a dynamic model would allow for the inclusion of the body accelerations and jerks.
Additionally the dynamic model would allow for the inclusion of the behaviour of the steering modules
more directly and thus lead to a more accurate control model. Finally a dynamic model would also allow
for the inclusion of skid and slip conditions as well as three dimensional movement on uneven terrain.
The drawback of a dynamic model is that it is more complex and thus requires more effort during
implementation and at run time.</p>
<p>At the moment I have not made any decisions on how to progress the swerve controller. It seems
logical to implement a dynamic model, however which model should be used and how to implement it
requires a bit more research. For the time being I'm planning my next step to be to design and
build a single drive module in real life.</p>

    </div>

    <div id="post-footer">
        <div>
    <div class="navlinks">
                <a href="/posts/Swerve-drive-ros2-nav" title="Previous Post: Swerve drive - Using Nav2" class="navlinks-prev">« Swerve drive - Using Nav2</a>
    </div>
</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mindvortex'; // required: replace example with your forum shortname
    var disqus_identifier = 'Swerve-drive-motor-limitations';
    var disqus_title = 'Swerve drive - Motor limitations';
    var disqus_url = 'https://www.petrikvandervelde.nl/posts/Swerve-drive-motor-limitations';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>
</div>







            </div>
        </div>

        <footer>
            <div id="footer" class="container">
    <div id="fbox1">
        <h2>Related</h2>
        <ul>
            <li><a href="https://github.com/pvandervelde"><i class="fa fa-github"></i> GitHub</a></li>
            <li><a href="https://www.linkedin.com/profile/view?id=33950311"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
            <li><a href="https://stackoverflow.com/users/539846/petrik"><i class="fa fa-stack-overflow"></i> StackOverflow</a></li>
            <li><a href="https://careers.stackoverflow.com/pvandervelde"><i class="fa fa-stack-overflow"></i> StackOverflow Careers</a></li>
            <li><a href="https://profile.codersrank.io/user/pvandervelde">CodersRank</a></li>
        </ul>
    </div>
    <div id="fbox2">
        <h2 id="copyright">Copyright</h2>
        <p>Copyright (c) 2024 <a href="/">Petrik van der Velde</a>. All rights reserved.</p>

        <h2 id="disclaimer">Disclaimer</h2>
        <p>The opinions expressed herein are my own personal opinions and do not represent my employer's view in any way.</p>
    </div>
    <div id="fbox3">
        <h2 id="media">Media</h2>
        <p><a href="/feed.atom"><img src="/assets/images/feed.png" alt="Atom feed"></a></p>
    </div>
</div>
<div id="copyright" class="container">
    <div>
        <p>
            Generated by <a href="https://wyam.io">Wyam</a> on Thu, 22 Feb 2024 09:15:58 GMT

 from commit <a href="https://github.com/pvandervelde/mindvortex/tree/8f0cb31f2b7d5b06ebc24f0520faedafad19887e">8f0cb31f2b7d5b06ebc24f0520faedafad19887e</a> at version 3.20.0.        </p>
    </div>

    <p>
        Site design based on the <a href="https://www.freecsstemplates.org/previews/opentools/">Open Tools</a> design
        by <a href="https://www.freecsstemplates.org">FreeCSSTemplates.org</a>.
    </p>
    <p>
        Feed icon by <a href="https://www.icojam.com/">Icojam</a> and Favicon by
        <a href="https://www.flaticon.com/free-icon/twister-sky-wind_12318" title="Yannick">Yannick</a>
        from <a href="https://www.flaticon.com" title="Flaticon">www.flaticon.com</a>
    </p>
</div>

        </footer>
    </body>
</html>
