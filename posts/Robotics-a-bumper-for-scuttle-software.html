
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Mind vortex - Starting robotics - Building a bumper for scuttle. The software</title>
        <meta name="description" content="Welcome!" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Mind vortex" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Mind vortex" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/normalize.css" rel="stylesheet" />
        <link href="/assets/css/h5bp.css" rel="stylesheet">
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
        <link href="/assets/css/override.css" rel="stylesheet" />
        <link href="/assets/css/github.css" rel="stylesheet" type="text/css">

        <script src="https://fred-wang.github.io/TeXZilla/TeXZilla-min.js"></script>
        <script src="https://fred-wang.github.io/TeXZilla/examples/customElement.js"></script>
        <link href="https://fred-wang.github.io/MathFonts/Asana/mathfonts.css" rel="stylesheet" />

        <meta name="application-name" content="Mind vortex" />
        <meta name="msapplication-tooltip" content="Mind vortex" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Mind vortex - Starting robotics - Building a bumper for scuttle. The software" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://www.petrikvandervelde.nl/posts/Robotics-a-bumper-for-scuttle-software" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>
        <script src="/assets/js/highlight.pack.js"></script>
        <script src="/assets/js/clean-blog.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

        <!-- Our scripts -->
<script src="/assets/js/script.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DV643VJGFT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DV643VJGFT');
</script>


    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->
        <div id="header" class="container">
            <div id="logo">
                <h1><a href="/">Mind vortex</a></h1>
            </div>
            <div id="menu">
                <ul>
                            <!-- Pages -->
        <!-- BlogPosts -->
        <!-- Tags -->
        <!-- TagIndex -->
        <!-- BlogArchive -->
        <!-- Index -->
        <!-- RenderTagIndex -->
        <!-- RenderTags -->
        <!-- RenderBlogArchive -->
        <!-- Feed -->
        <!-- RenderBlogPosts -->
    <!-- Context.Documents['Pages'] -->
        <!-- 404 Not Found - False - /404 -->
        <!-- About - True - /about -->
        <!-- Projects - True - /projects -->
        <!-- Robotics - False - /projects/robotics -->
        <!-- Scuttle - False - /projects/scuttle -->
        <!-- Zinger - False - /projects/zinger -->
            <li class="inactive" >
                <a href="/">Home</a>
            </li>
            <li class="inactive" >
                <a href="/projects">Projects</a>
            </li>
            <li class="inactive" >
                <a href="/posts">Archive</a>
            </li>
            <li class="inactive" >
                <a href="/tags">Tags</a>
            </li>
            <li class="inactive" >
                <a href="/about">About</a>
            </li>

                </ul>
            </div>
        </div>

        <div id="page" class="container">
            <div id="sidebar">
                <div id="sbox1">
                    <h2>Patrick van der Velde</h2>

<p>
    <img src="https://www.gravatar.com/avatar/9bc8b3ff385cd14f2b12138c97729df2?s=160"
        alt="Gravatar for Patrick van der Velde">
</p>
<p>
    I am a senior lead software engineer who is living, working and playing in New Zealand.
    Developer of the <a href="/tags/Zinger">Zinger robot</a>, contributor on the
    <a href="/tags/Scuttle">Scuttle project</a>.

    In my spare time wood worker, rock climber, gardner.
</p>
<p>
    <a href="/about.html">More ...</a>
</p>

                </div>
                <div id="sbox2">
                    <h2>Recent</h2>
                    <ul class="list-unstyled">
                            <li><a href="/posts/Swerve-drive-ros2-nav">Swerve drive - Using Nav2</a></li>
                            <li><a href="/posts/Robotics-making-urdf-models">Robotics - Making URDF models</a></li>
                            <li><a href="/posts/Swerve-motion-profiles">Swerve drive - Motion profiles</a></li>
                            <li><a href="/posts/Swerve-drive-control-animations">Swerve drive - Movement animations</a></li>
                            <li><a href="/posts/Swerve-drive-body-focussed-control">Swerve drive - Better movement by controlling the body motions</a></li>
                            <li><a href="/posts/Swerve-drive-kinematics-verification">Swerve drive - Verification of the kinematics solution</a></li>
                            <li><a href="/posts/Swerve-drive-kinematics-simulation">Swerve drive - Kinematics simulation</a></li>
                            <li><a href="/posts/Swerve-drive-introduction">Swerve drive - Moving a robot in all directions, mostly</a></li>
                            <li><a href="/posts/Robotics-fixing-scuttles-encoder">Starting robotics - Fixing the wheel encoders</a></li>
                            <li><a href="/posts/Robotics-a-bumper-for-scuttle-electronics">Starting robotics - Building a bumper for scuttle. The electronics</a></li>
                    </ul>
                </div>
                <div id="sbox3">
                    <h2>Tags</h2>
                    <div>
                        <ul class="list-unstyled">
                                <li>
                                    <a role="button" href="/tags/Robotics" class="btn btn-default btn-sm"> Robotics (16)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Sherlock" class="btn btn-default btn-sm"> Sherlock (13)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/nBuildKit" class="btn btn-default btn-sm"> nBuildKit (12)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/DevOps" class="btn btn-default btn-sm"> DevOps (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Software-development-pipeline" class="btn btn-default btn-sm"> Software development pipeline (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Delivering-software" class="btn btn-default btn-sm"> Delivering software (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Paragliding" class="btn btn-default btn-sm"> Paragliding (9)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/PG2" class="btn btn-default btn-sm"> PG2 (9)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Zinger" class="btn btn-default btn-sm"> Zinger (8)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Omnidirectional" class="btn btn-default btn-sm"> Omnidirectional (7)</a>
                                </li>
                        </ul>
                    </div>
                    <br />
                    <ul class="pager">
                        <li class="next">
                            <a href="/tags">View All Tags &rarr;</a>
                        </li>
                    </ul>
                </div>
            </div>

            <div id="content">

<div id="post">
    <div id="post-header">
        <!--
    Model is: Tuple<IDocument, IDocument>.
    The first one is the current document that is being rendered, the second one is the one for which the post header should be rendered.
-->


<h2>
Starting robotics - Building a bumper for scuttle. The software</h2>
<div id="post-meta">
    <div class="meta-date">
Friday, September 9, 2022
 |             Posted in     </div>
    <div class="meta-tags">
                        <a id="post-category" role="button" href="/tags/Robotics" class="btn btn-default btn-xs tag-no-wrap">Robotics</a>
                        <a id="post-category" role="button" href="/tags/ROS" class="btn btn-default btn-xs tag-no-wrap">ROS</a>
                        <a id="post-category" role="button" href="/tags/ROS-Noetic" class="btn btn-default btn-xs tag-no-wrap">ROS&nbsp;Noetic</a>
                        <a id="post-category" role="button" href="/tags/Scuttle" class="btn btn-default btn-xs tag-no-wrap">Scuttle</a>
    </div>
</div>

    </div>

    <div id="post-content">
        <p>In my <a href="posts/Robotics-a-bumper-for-scuttle-overview">previous post</a> I talked about creating a bump
sensor for my SCUTTLE robot. After creating the mechanical design I started working on the software.
There are two parts to the software, translating the state of the micro switches and turning the state
changes into movement commands for the robot, i.e. if the robot runs into
an obstacle it should stop and reverse its last movement. I decided to create a
<a href="https://www.ros.org/">ROS</a> node for each of these actions, i.e. one node
for the movement generation and one to translate the switch states. The reason for
creating two nodes instead of putting all the code into one node is that this allows me to run the
movement generation code both in a simulation and on the physical robot. So I gain the ability to
test more of my code, but I lose a bit of performance because the two nodes communicate using
messages which is slower than just using method calls.</p>
<p>To test the bump sensor code I use <a href="https://gazebosim.org/home">Gazebo</a> to simulate how the bump
sensor would work. Gazebo has the ability to calculate collisions
and create <a href="http://docs.ros.org/en/api/gazebo_msgs/html/msg/ContactsState.html">ContactsState</a>
messages based on these collision calculations. So I created a third ROS node to translate these
Gazebo messages to my own <a href="https://github.com/pvandervelde/scuttle_ros_msgs/blob/noetic/msg/BumperEvent.msg">bumper event messages</a>.
With that I can test my obstacle response code in Gazebo which provides a more controlled environment
than the physical robot does.</p>
<p>The first thing to do is to update the robot definition to include the bumper. This is done by adding
the <a href="http://wiki.ros.org/urdf/XML/link">links</a> and <a href="http://wiki.ros.org/urdf/XML/joint">joints</a> that
make up my bumper to an <a href="https://github.com/pvandervelde/scuttle_bumper/blob/master/urdf/bumper.xacro">URDF file</a>.
This URDF file is linked to the main <a href="https://github.com/scuttlerobot/scuttle_description">model description</a>
for SCUTTLE. After that I added the information for the <a href="https://classic.gazebosim.org/tutorials?tut=ros_gzplugins#Bumper">Gazebo bumper sensor</a>.
In the URDF file this looks as follows:</p>
<pre><code>    &lt;gazebo reference=&quot;front_bumper_plate_left_link&quot;&gt;
        &lt;sensor name=&quot;front_bumper_left&quot; type=&quot;contact&quot;&gt;
            &lt;selfCollide&gt;true&lt;/selfCollide&gt;
            &lt;alwaysOn&gt;true&lt;/alwaysOn&gt;
            &lt;updateRate&gt;15.0&lt;/updateRate&gt;
            &lt;material&gt;Gazebo/WhiteGlow&lt;/material&gt;
            &lt;contact&gt;
                &lt;collision&gt;base_link_fixed_joint_lump__front_bumper_plate_left_cl_collision_3&lt;/collision&gt;
                &lt;topic&gt;bumper_contact&lt;/topic&gt;
            &lt;/contact&gt;
            &lt;plugin name=&quot;gazebo_ros_bumper_controller_front_left&quot; filename=&quot;libgazebo_ros_bumper.so&quot;&gt;
                &lt;bumperTopicName&gt;scuttle_bumper&lt;/bumperTopicName&gt;
                &lt;frameName&gt;front_bumper_plate_left_link&lt;/frameName&gt;
            &lt;/plugin&gt;
        &lt;/sensor&gt;
    &lt;/gazebo&gt;
</code></pre>
<p>I found that defining a contact sensor for Gazebo requires getting the link ID correct. In order to
do so you need to follow these steps:</p>
<ul>
<li>The bumper contact information needs to be defined inside a <a href="https://classic.gazebosim.org/tutorials?tut=ros_urdf&amp;cat=connect_ros"><code>gazebo</code></a>
element. This <code>gazebo</code> element should have a <code>reference</code> attribute that points to the link that is
to be used as the bumper surface.</li>
<li>The name for the <code>collision</code> element needs to be found after translation to the SDF format. Normally
this is something Gazebo does internally. In this case you'll need to do this manually. If your
geometry is defined in an <a href="http://wiki.ros.org/xacro">xacro</a> file then you first need to translate
this to URDF using the <code>rosrun xacro xacro --inorder -o model.urdf model.urdf.xacro</code> command. After
that you can translate the URDF to SDF with the <code>gz sdf -p scuttle.urdf &gt; scuttle.sdf</code> command. Once
you have the SDF file you can search for the
<a href="https://answers.gazebosim.org/question/21992/what-collision-name-is-supposed-to-be-passed-to-contact-sensor/">correct element IDs</a>.</li>
</ul>
<p>In the above example the collision name, <code>base_link_fixed_joint_lump__front_bumper_plate_left_cl_collision_3</code>,
is the one you need to extract from the SDF file. Note that it can change if you make changes to
your xacro / URDF file, so in that case you will need to extract it again.</p>
<p>Once you have defined the URDF Gazebo will generate contact messages when the bumper hits an object.
These contact messages contain information describing where the contact occurred on the geometry mesh,
so in theory I could have used this information to determine if the contact would trigger the left
limit switch or the right limit switch or both. However that requires a decent amount of calculations
which is both work and introduces the potential for errors. So I opted to split the bumper into
two parts, one for the left side and one for the right side. If anything contacts anywhere on the
left side I consider that a trigger for the left part of the bumper and similar for the right side.</p>
<figure style="float:left">
<img alt="SCUTTLE with bumper in RViz" src="/assets/images/robotics/scuttle/scuttle-with-bumper-in-rviz.png" />
<figcaption>SCUTTLE with bumper in RViz</figcaption>
</figure>
<p>With the URDF work done I started writing the code for the different ROS nodes. First
the <a href="https://github.com/pvandervelde/scuttle_bumper/blob/master/src/gazebo_contact_sensor_translator.py">gazebo translator node</a>.
This node subscribes to the <a href="http://docs.ros.org/en/api/gazebo_msgs/html/msg/ContactsState.html">ContactsState</a>
messages that Gazebo sends when the bumper geometry collides with something. These messages are then
translated to a <a href="https://github.com/pvandervelde/scuttle_ros_msgs/blob/noetic/msg/BumperEvent.msg">BumperEvent</a>
message for further processing.</p>
<p>One interesting observation about the Gazebo contact messages are that they exhibit something
similar to <a href="https://www.pcmag.com/index.php/encyclopedia/term/switch-bounce">switch bounce</a>, in other
words it seems that the contact is intermittent even if the bumper plate is in solid contact with
the object. I'm guessing that this is caused by the fact that calculating collisions between moving
surfaces is difficult. In the end it doesn't matter what causes this behaviour though because we
need to <a href="https://github.com/pvandervelde/scuttle_bumper/blob/master/src/debounce.py">deal with it</a> in
some sensible way.</p>
<p>Once the bumper event messages have been generated they are processed by the
<a href="https://github.com/pvandervelde/scuttle_bumper/blob/master/src/bumper_navigator.py">second node</a>.
This node subscribes to both odometry events and bumper events. Internally it keeps track of the
motion state of SCUTTLE. On reception of a bumper event the node sends a
<a href="http://docs.ros.org/en/noetic/api/geometry_msgs/html/msg/Twist.html">velocity command</a>
to stop the robot. Once the robot has stopped it sends commands for it to reverse course far enough
that it is no longer contact with the obstacle.</p>
<p>One thing to note is that while the bumper code is working to reverse course after hitting an obstacle,
the other parts of ROS, e.g. the navigation stack, are probably still trying to steer the robot in the
original direction because those parts don't know about the obstacle. After all it is not on the
navigation map. This results in many different velocity commands being send, which could be very
confusing for the robot. One design decision was to make the bumper code unaware of other nodes. This
was done because allowing the bumper code to supress velocity
commands from other nodes would imply that the bumper code is always the most important publisher
when it comes to velocity commands. There are cases where this isn't true, e.g. when using
the bumpers to park SCUTTLE against a specific object like in the case of a docking station.</p>
<p>To ensure that a consistent set of velocity commands are sent to the motors I used the
<a href="http://wiki.ros.org/twist_mux">twist multiplexer node</a> which takes in velocity commands from
many nodes and forwards them using a priority-based scheme. In the current implementation the
priorities are, from low to high</p>
<ul>
<li>Navigation</li>
<li>Keyboard</li>
<li>Bumper</li>
<li>Joypad / Joystick</li>
</ul>
<iframe
    style="float:right"
    width="560"
    height="315"
    src="https://www.youtube.com/embed/SddexyGTJ0M"
    title="YouTube video player"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen>
</iframe>
<p>By using the twist multiplexer mode it is easy for users to change the priority by changing a configuration
file instead of having to change the bumper code.</p>
<p>With that the bumper code is able to make SCUTTLE respond to objects it bumps into. The next step in
the process of adding bump sensors to SCUTTLE is to assemble the electronic components so that the
movement of the bumper can be registered and reported to the software components.</p>
<p>Finally a addition to the software that needs to be made is the ability to add the obstacles in the
navigation map so that SCUTTLE can navigate around the newly discovered obstacles.</p>

    </div>

    <div id="post-footer">
        <div>
    <div class="navlinks">
                <a href="/posts/Robotics-a-bumper-for-scuttle-overview" title="Previous Post: Starting robotics - Building a bumper for scuttle. The overview" class="navlinks-prev">« Starting robotics - Building a bumper for scuttle. The overview</a>
                <a href="/posts/Robotics-a-bumper-for-scuttle-electronics" title="Next Post: Starting robotics - Building a bumper for scuttle. The electronics" class="navlinks-next">Starting robotics - Building a bumper for scuttle. The electronics »</a>
    </div>
</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mindvortex'; // required: replace example with your forum shortname
    var disqus_identifier = 'Robotics-a-bumper-for-scuttle-software';
    var disqus_title = 'Starting robotics - Building a bumper for scuttle. The software';
    var disqus_url = 'https://www.petrikvandervelde.nl/posts/Robotics-a-bumper-for-scuttle-software';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>
</div>







            </div>
        </div>

        <footer>
            <div id="footer" class="container">
    <div id="fbox1">
        <h2>Related</h2>
        <ul>
            <li><a href="https://github.com/pvandervelde"><i class="fa fa-github"></i> GitHub</a></li>
            <li><a href="https://www.linkedin.com/profile/view?id=33950311"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
            <li><a href="https://stackoverflow.com/users/539846/petrik"><i class="fa fa-stack-overflow"></i> StackOverflow</a></li>
            <li><a href="https://careers.stackoverflow.com/pvandervelde"><i class="fa fa-stack-overflow"></i> StackOverflow Careers</a></li>
            <li><a href="https://profile.codersrank.io/user/pvandervelde">CodersRank</a></li>
        </ul>
    </div>
    <div id="fbox2">
        <h2 id="copyright">Copyright</h2>
        <p>Copyright (c) 2024 <a href="/">Petrik van der Velde</a>. All rights reserved.</p>

        <h2 id="disclaimer">Disclaimer</h2>
        <p>The opinions expressed herein are my own personal opinions and do not represent my employer's view in any way.</p>
    </div>
    <div id="fbox3">
        <h2 id="media">Media</h2>
        <p><a href="/feed.atom"><img src="/assets/images/feed.png" alt="Atom feed"></a></p>
    </div>
</div>
<div id="copyright" class="container">
    <div>
        <p>
            Generated by <a href="https://wyam.io">Wyam</a> on Wed, 17 Jan 2024 10:03:54 GMT

 from commit <a href="https://github.com/pvandervelde/mindvortex/tree/05dbee417d0231bfe88d46f743816596cab3224a">05dbee417d0231bfe88d46f743816596cab3224a</a> at version 3.19.0.        </p>
    </div>

    <p>
        Site design based on the <a href="https://www.freecsstemplates.org/previews/opentools/">Open Tools</a> design
        by <a href="https://www.freecsstemplates.org">FreeCSSTemplates.org</a>.
    </p>
    <p>
        Feed icon by <a href="https://www.icojam.com/">Icojam</a> and Favicon by
        <a href="https://www.flaticon.com/free-icon/twister-sky-wind_12318" title="Yannick">Yannick</a>
        from <a href="https://www.flaticon.com" title="Flaticon">www.flaticon.com</a>
    </p>
</div>

        </footer>
    </body>
</html>
