
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Mind vortex - Sherlock configuration - Build server integration</title>
        <meta name="description" content="Welcome!" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Mind vortex" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Mind vortex" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/normalize.css" rel="stylesheet" />
        <link href="/assets/css/h5bp.css" rel="stylesheet">
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
        <link href="/assets/css/override.css" rel="stylesheet" />
        <link href="/assets/css/github.css" rel="stylesheet" type="text/css">


        <meta name="application-name" content="Mind vortex" />
        <meta name="msapplication-tooltip" content="Mind vortex" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Mind vortex - Sherlock configuration - Build server integration" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://www.petrikvandervelde.nl/posts/Integrating-Sherlock-with-a-build-server" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>
        <script src="/assets/js/highlight.pack.js"></script>
        <script src="/assets/js/clean-blog.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

        <!-- Our scripts -->
<script src="/assets/js/script.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DV643VJGFT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DV643VJGFT');
</script>


    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->
        <div id="header" class="container">
            <div id="logo">
                <h1><a href="/">Mind vortex</a></h1>
            </div>
            <div id="menu">
                <ul>
                            <!-- Pages -->
        <!-- BlogPosts -->
        <!-- Tags -->
        <!-- TagIndex -->
        <!-- BlogArchive -->
        <!-- Index -->
        <!-- RenderTagIndex -->
        <!-- RenderTags -->
        <!-- RenderBlogArchive -->
        <!-- Feed -->
        <!-- RenderBlogPosts -->
    <!-- Context.Documents['Pages'] -->
        <!-- 404 Not Found - False - /404 -->
        <!-- About - True - /about -->
        <!-- Calvinverse - False - /projects/calvinverse -->
        <!-- nBuildKit - False - /projects/nbuildkit -->
        <!-- Projects - True - /projects -->
        <!-- Scuttle - False - /projects/scuttle -->
            <li class="inactive" >
                <a href="/">Home</a>
            </li>
            <li class="inactive" >
                <a href="/projects">Projects</a>
            </li>
            <li class="inactive" >
                <a href="/posts">Archive</a>
            </li>
            <li class="inactive" >
                <a href="/tags">Tags</a>
            </li>
            <li class="inactive" >
                <a href="/about">About</a>
            </li>

                </ul>
            </div>
        </div>

        <div id="page" class="container">
            <div id="sidebar">
                <div id="sbox1">
                    <h2>Patrick van der Velde</h2>

<p>
    <img src="https://www.gravatar.com/avatar/9bc8b3ff385cd14f2b12138c97729df2?s=160" alt="Gravatar for Patrick van der Velde">
</p>
<p>
    Dutch software developer who is living, working and playing in New Zealand.
    Rock climber and paragliding pilot. Developer of
    <a href="https://nbuildkit.github.io/nBuildKit.MsBuild/">nBuildKit</a>,
    <a href="https://github.com/Calvinverse">the Calvinverse resources</a> and other projects.
</p>
<p>
    <a href="/about.html">More ...</a>
</p>

                </div>
                <div id="sbox2">
                    <h2>Recent</h2>
                    <ul class="list-unstyled">
                            <li><a href="/posts/Robotics-a-bumper-for-scuttle-software">Starting robotics - Building a bumper for scuttle. The software</a></li>
                            <li><a href="/posts/Robotics-a-bumper-for-scuttle-overview">Starting robotics - Building a bumper for scuttle. The overview</a></li>
                            <li><a href="/posts/Robotics-driving-scuttle-with-ros-gazebo-simulation">Starting robotics - Driving scuttle with ROS - Gazebo simulation</a></li>
                            <li><a href="/posts/Robotics-learning-ros">Starting robotics - Learning Robot Operating System (ROS)</a></li>
                            <li><a href="/posts/Starting-robotics-with-scuttle">Starting robotics with the SCUTTLE robot</a></li>
                            <li><a href="/posts/Building-autonomous-mobile-robot-why">Building an autonomous mobile robot - But why?</a></li>
                            <li><a href="/posts/Software-development-pipeline-security">Software development pipeline - Security</a></li>
                            <li><a href="/posts/Software-development-pipeline-infrastructure-dependency-reduction">Software development pipeline - Infrastructure dependency reduction</a></li>
                            <li><a href="/posts/Calvinverse-an-example-build-infrastructure">Calvinverse - An example build infrastructure</a></li>
                            <li><a href="/posts/On-prem-vs-cloud-build-systems">Software development pipeline - On-prem or in the cloud?</a></li>
                    </ul>
                </div>
                <div id="sbox3">
                    <h2>Tags</h2>
                    <div>
                        <ul class="list-unstyled">
                                <li>
                                    <a role="button" href="/tags/Sherlock" class="btn btn-default btn-sm"> Sherlock (13)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/nBuildKit" class="btn btn-default btn-sm"> nBuildKit (12)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Delivering-software" class="btn btn-default btn-sm"> Delivering software (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Software-development-pipeline" class="btn btn-default btn-sm"> Software development pipeline (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/DevOps" class="btn btn-default btn-sm"> DevOps (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/PG2" class="btn btn-default btn-sm"> PG2 (9)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Paragliding" class="btn btn-default btn-sm"> Paragliding (9)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Blog" class="btn btn-default btn-sm"> Blog (7)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Pipeline-design" class="btn btn-default btn-sm"> Pipeline design (6)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Robotics" class="btn btn-default btn-sm"> Robotics (6)</a>
                                </li>
                        </ul>
                    </div>
                    <br />
                    <ul class="pager">
                        <li class="next">
                            <a href="/tags">View All Tags &rarr;</a>
                        </li>
                    </ul>
                </div>
            </div>

            <div id="content">

<div id="post">
    <div id="post-header">
        <!--
    Model is: Tuple<IDocument, IDocument>.
    The first one is the current document that is being rendered, the second one is the one for which the post header should be rendered.
-->


<h2>
Sherlock configuration - Build server integration</h2>
<div id="post-meta">
    <div class="meta-date">
Monday, January 13, 2014
 |             Posted in     </div>
    <div class="meta-tags">
                        <a id="post-category" role="button" href="/tags/Jenkins" class="btn btn-default btn-xs tag-no-wrap">Jenkins</a>
                        <a id="post-category" role="button" href="/tags/MsBuild" class="btn btn-default btn-xs tag-no-wrap">MsBuild</a>
                        <a id="post-category" role="button" href="/tags/Sherlock" class="btn btn-default btn-xs tag-no-wrap">Sherlock</a>
                        <a id="post-category" role="button" href="/tags/TeamCity" class="btn btn-default btn-xs tag-no-wrap">TeamCity</a>
    </div>
</div>

    </div>

    <div id="post-content">
        <p>Once the configuration of <a href="/projects/sherlock.html">Sherlock</a> is complete the last step needed to
make use of automatic regression testing is to integrate with a build server. In this post I will
explain which steps need to be taken to integrate Sherlock with a build server. Examples will be
given for <a href="https://jenkins.io/">Jenkins</a>, which is used at my work, and
<a href="https://www.jetbrains.com/teamcity/">TeamCity</a>, which I use personally.</p>
<p>In order to integrate with a build server you will need to:</p>
<ul>
<li>Create at least one test configuration</li>
<li>Write the build scripts necessary to register a test, wait for the completion of the test and
process the results.</li>
<li>Set up a job on the build server to execute the test.</li>
</ul>
<h3>Test configurations</h3>
<p>In order to execute a test the first thing you need to decide on is the test configuration which
will be executed. In Sherlock the test configuration is described by a XML file similar to the
following gist:</p>
<script src="https://gist.github.com/pvandervelde/8346703.js"></script>)
<p>In this configuration file replace all instances of <code>${SOME_TEXT}$</code> with the appropriate information.
Note that some configuration settings should be templated so that those values can be supplied by the
build system, e.g. the application version number:</p>
<ul>
<li>Provide an application name and version for use in the test report.</li>
<li>Provide a compact description. This will be used as the title of the test report</li>
<li>Provide each environment with a name. It doesn't matter what that name is as long as it is
consistently used throughout the configuration file. All test steps which should be executed on
the same environment should be linked to the same environment name. Note that while it is possible
to request multiple environments to be started in a test, it is not possible to synchronize those
environments. In other words each environment will exit as soon as it completes the test steps
assigned to it, no environment will wait for other environments to complete their work.</li>
<li>For each test step that needs to be executed provide the order (integer number starting at 0,
incrementing for each step), the name of the environment in which the step should be executed, the
failure mode, either Stop or Continue and the correct file paths. Note that the test steps use the
following definitions for their file paths:
<ul>
<li><strong>msi:</strong> <code>file</code> is the absolute path to the MSI file as on the machine that is used to register
the test (i.e. the origin).</li>
<li><strong>x-copy:</strong> <code>destination</code> is the absolute path to the directory that will hold all the x-copy
results on the test environment.</li>
<li><strong>x-copy:</strong> <code>base</code> is the absolute path to the directory that holds the files / directories to
be x-copied on the origin.</li>
<li><strong>x-copy:</strong> <code>paths</code> contains the absolute paths to the files / directories that should be
x-copied. It is expected that these all reside in the <code>base</code> directory at some level.</li>
<li><strong>script:</strong> <code>file</code> is the absolute path to the script file on the origin.</li>
<li><strong>console:</strong> <code>exe</code> is the absolute path to the executable that should be executed on the test
environment. Note that the path is also pointed to the test environment. Hence the <code>CONSOLE</code>
test step is the only test step that doesn't copy files.</li>
<li><strong>All test steps:</strong> All files and directories that should be included in the report are
absolute paths on the test environment.</li>
<li><strong>notification:</strong> The absolute path where the final report should be placed. This path should
be accessible to both Sherlock (the master controller) and the application that will process the test results.</li>
</ul>
</li>
<li>It makes sense to always copy back any logs that are written during the test. If you don't need
them for test failure diagnosis then it is easy to delete them later, however you can't copy them
from the test environment after the test has completed because the test environment will be reset
to its original state upon shut down.</li>
</ul>
<p>If you need tests to run in different environments or with different test steps then you will need to
create a configuration file for each environment / set of test steps.</p>
<h3>Build scripts</h3>
<p>The easiest way to execute the test from a build server is to create a set of build scripts that can
do the work for you. In this example I will be using MsBuild as the scripting language.</p>
<p>In order to create the configuration file from the template it is necessary to replace all the
templated configuration settings with their current values. The following gist shows an inline
MsBuild task that does exactly that:</p>
<script src="https://gist.github.com/pvandervelde/8277812.js?file=TemplateFile.xml"></script>
<p>In order to use this task create an <code>ItemGroup</code> with the identifiers of the settings and their
replacement values. For example:</p>
<script src="https://gist.github.com/pvandervelde/8277812.js?file=HowToUseTemplateFile.xml"></script>
<p>If this example is used on the following template file:</p>
<script src="https://gist.github.com/pvandervelde/8277812.js?file=BeforeReplacement.xml"></script>
<p>Then the outcome is the following output file:</p>
<script src="https://gist.github.com/pvandervelde/8277812.js?file=AfterReplacement.xml"></script>
<p>The next step will be to create a build script that can register the test with the Sherlock system.
This can either be done with a call to the
<a href="https://msdn.microsoft.com/en-us/library/x8zx72cd.aspx">exec</a> task or with the following inline
MsBuild task:</p>
<script src="https://gist.github.com/pvandervelde/8346876.js"></script>
<p>The next step is a little tricky in that it is now necessary to wait for Sherlock to execute the
test and create the test report. The tricky bit due to the fact that Sherlock will only execute the
tests when a suitable test environment is available. That means that tests could be executed almost
immediately if an environment is directly available, or not for a long time if all environments are
busy. On top of that MsBuild does not have the ability to watch specific files. The following inline
task allows you to wait for certain files to be created. Note that you need to provide a time-out
which determines how long this task will wait for the report files. How long this time-out should be
depends on:</p>
<ul>
<li>How long it takes for the tests to execute.</li>
<li>How many tests will be executed on the same test environments. Tests executing on different test
environments can be run in parallel provided the hardware will stand up to it.</li>
<li>How many other tests may potentially be executing at the same time.</li>
</ul>
<script src="https://gist.github.com/pvandervelde/8346893.js"></script>
<p>Finally the report files need to be checked for success or failure. For each test Sherlock produces
a HTML and an XML report. The easiest way to find the outcome of a test is to parse the XML report
and search for the <code>result</code> element. The value of this element will either be <code>Passed</code> or <code>Failed</code>.
The following inline task will accomplish this goal:</p>
<script src="https://gist.github.com/pvandervelde/8346900.js"></script>
<h3>Build jobs</h3>
<p>The final task is to setup one or more build jobs for the build server to execute. While you can
combine the testing steps with the build steps it is in general advisable to have a separate job for
the testing steps. The main reason for that is that the the testing steps can take quite a while to
execute, ranging from several minutes to hours, which slows down the continuous integration feedback
cycle considerably. Based on the idea that the tests should be contained in their own build job the
following set-up is proposed.</p>
<ul>
<li>Define three different build jobs for the build, test and deploy stages of the process. This means
that each job will be responsible for a specific task. Individual jobs will be use the artefacts
produced by the other jobs.</li>
<li>Set up dependencies between the different builds where required. For instance the test job will
depend on the artefacts produced by the build job.</li>
<li>The build job can be run both as continuous integration build, i.e. execute the build job each
time a commit to the source control system is detected, and as pre-requisite to the test job.</li>
<li>Similarly the test job could be run nightly to provide relatively quick feedback on regression
problems while also acting as pre-requisite to the deploy job.</li>
<li>If the version number includes either the build counter of the build job or the revision number of
the source control commit then special care needs to be taken for the test and deploy jobs in
order to ensure that they get the same numbers as the build job did.</li>
<li>In a similar fashion it will be necessary to control the version control settings so that all builds
pull in the same revision. One solution would be to store the revision index in the first job in
the chain and then transfer that to the other jobs.</li>
</ul>
<p>For the two build systems I have specifically worked with the following additional notes can be made:</p>
<ul>
<li><a href="https://jenkins.io/">Jenkins</a>
<ul>
<li>In addition to the three standard jobs you will probably need a <a href="https://wiki.jenkins-ci.org/display/JENKINS/Build+Flow+Plugin">Build flow</a>
job to trigger the different standard jobs in the right order. This has to be done because at
the moment it does not seem possible in Jenkins to trigger pre-requisite builds without having
the downstream project taking up one of the build executors. The build flow jobs live outside
the actual build executors which makes it possible to optimize the use of the executors.</li>
<li>In order to deal with the build number problems as specified above the simplest way is to write
the number to a file in the upstream job, archive that and then pull it out in the downstream jobs.
The same goes for the version control information.</li>
</ul>
</li>
<li><a href="https://www.jetbrains.com/teamcity/">TeamCity</a>
<ul>
<li>Downstream jobs have both a snapshot dependency and an artefact dependency on the upstream job.
The <a href="https://confluence.jetbrains.com/display/TCD8/Configuring+Dependencies">snapshot dependency</a>
takes care of the synchronization of the version control revision. Note that you should create
different VCS roots for each project, otherwise the projects all share a single check-out directory.
By sharing a single directory it is possible that upon starting the second job the directory is
cleaned which will likely remove the artefacts from the first job.</li>
<li>The build number can be copied easily by <a href="https://confluence.jetbrains.com/display/TCD8/Configuring+General+Settings#ConfiguringGeneralSettings-BuildNumberFormat">synchronizing</a>
the build numbers.</li>
</ul>
</li>
</ul>

    </div>

    <div id="post-footer">
        <div>
    <div class="navlinks">
                <a href="/posts/Sherlock-Release-V0480" title="Previous Post: Sherlock release - V0.4.8.0" class="navlinks-prev">« Sherlock release - V0.4.8.0</a>
                <a href="/posts/PG2-Christmas-holiday-antics" title="Next Post: PG2 - Christmas holiday antics" class="navlinks-next">PG2 - Christmas holiday antics »</a>
    </div>
</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mindvortex'; // required: replace example with your forum shortname
    var disqus_identifier = 'Integrating-Sherlock-with-a-build-server';
    var disqus_title = 'Sherlock configuration - Build server integration';
    var disqus_url = 'https://www.petrikvandervelde.nl/posts/Integrating-Sherlock-with-a-build-server';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>
</div>







            </div>
        </div>

        <footer>
            <div id="footer" class="container">
    <div id="fbox1">
        <h2>Related</h2>
        <ul>
            <li><a href="https://github.com/pvandervelde"><i class="fa fa-github"></i> GitHub</a></li>
            <li><a href="https://www.linkedin.com/profile/view?id=33950311"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
            <li><a href="https://stackoverflow.com/users/539846/petrik"><i class="fa fa-stack-overflow"></i> StackOverflow</a></li>
            <li><a href="https://careers.stackoverflow.com/pvandervelde"><i class="fa fa-stack-overflow"></i> StackOverflow Careers</a></li>
            <li><a href="https://profile.codersrank.io/user/pvandervelde">CodersRank</a></li>
        </ul>
    </div>
    <div id="fbox2">
        <h2 id="copyright">Copyright</h2>
        <p>Copyright (c) 2022 <a href="/">Petrik van der Velde</a>. All rights reserved.</p>

        <h2 id="disclaimer">Disclaimer</h2>
        <p>The opinions expressed herein are my own personal opinions and do not represent my employer's view in any way.</p>
    </div>
    <div id="fbox3">
        <h2 id="media">Media</h2>
        <p><a href="/feed.atom"><img src="/assets/images/feed.png" alt="Atom feed"></a></p>
    </div>
</div>
<div id="copyright" class="container">
    <div>
        <p>
            Generated by <a href="https://wyam.io">Wyam</a> on Fri, 09 Sep 2022 07:16:51 GMT

 from commit <a href="https://github.com/pvandervelde/mindvortex/tree/62fc793f8eacf7a47644801d34c14b43863dc285">62fc793f8eacf7a47644801d34c14b43863dc285</a> at version 3.9.0.        </p>
    </div>

    <p>
        Site design based on the <a href="https://www.freecsstemplates.org/previews/opentools/">Open Tools</a> design
        by <a href="https://www.freecsstemplates.org">FreeCSSTemplates.org</a>.
    </p>
    <p>
        Feed icon by <a href="https://www.icojam.com/">Icojam</a> and Favicon by
        <a href="https://www.flaticon.com/free-icon/twister-sky-wind_12318" title="Yannick">Yannick</a>
        from <a href="https://www.flaticon.com" title="Flaticon">www.flaticon.com</a>
    </p>
</div>

        </footer>
    </body>
</html>
