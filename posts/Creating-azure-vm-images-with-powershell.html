
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Mind vortex - Creating Azure VM images with Powershell</title>
        <meta name="description" content="Welcome!" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Mind vortex" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Mind vortex" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/normalize.css" rel="stylesheet" />
        <link href="/assets/css/h5bp.css" rel="stylesheet">
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
        <link href="/assets/css/override.css" rel="stylesheet" />
        <link href="/assets/css/github.css" rel="stylesheet" type="text/css">

        <script src="https://fred-wang.github.io/TeXZilla/TeXZilla-min.js"></script>
        <script src="https://fred-wang.github.io/TeXZilla/examples/customElement.js"></script>
        <link href="https://fred-wang.github.io/MathFonts/Asana/mathfonts.css" rel="stylesheet" />

        <meta name="application-name" content="Mind vortex" />
        <meta name="msapplication-tooltip" content="Mind vortex" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Mind vortex - Creating Azure VM images with Powershell" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://www.petrikvandervelde.nl/posts/Creating-azure-vm-images-with-powershell" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>
        <script src="/assets/js/highlight.pack.js"></script>
        <script src="/assets/js/clean-blog.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

        <!-- Our scripts -->
<script src="/assets/js/script.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DV643VJGFT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DV643VJGFT');
</script>


    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->
        <div id="header" class="container">
            <div id="logo">
                <h1><a href="/">Mind vortex</a></h1>
            </div>
            <div id="menu">
                <ul>
                            <!-- Pages -->
        <!-- BlogPosts -->
        <!-- Tags -->
        <!-- TagIndex -->
        <!-- BlogArchive -->
        <!-- Index -->
        <!-- RenderTagIndex -->
        <!-- RenderTags -->
        <!-- RenderBlogArchive -->
        <!-- Feed -->
        <!-- RenderBlogPosts -->
    <!-- Context.Documents['Pages'] -->
        <!-- 404 Not Found - False - /404 -->
        <!-- About - True - /about -->
        <!-- Projects - True - /projects -->
        <!-- Robotics - False - /projects/robotics -->
        <!-- Scuttle - False - /projects/scuttle -->
            <li class="inactive" >
                <a href="/">Home</a>
            </li>
            <li class="inactive" >
                <a href="/projects">Projects</a>
            </li>
            <li class="inactive" >
                <a href="/posts">Archive</a>
            </li>
            <li class="inactive" >
                <a href="/tags">Tags</a>
            </li>
            <li class="inactive" >
                <a href="/about">About</a>
            </li>

                </ul>
            </div>
        </div>

        <div id="page" class="container">
            <div id="sidebar">
                <div id="sbox1">
                    <h2>Patrick van der Velde</h2>

<p>
    <img src="https://www.gravatar.com/avatar/9bc8b3ff385cd14f2b12138c97729df2?s=160"
        alt="Gravatar for Patrick van der Velde">
</p>
<p>
    Dutch software developer who is living, working and playing in New Zealand.
    Rock climber and wood worker. Developer of the
    <a href="https://github.com/pvandervelde?tab=repositories&q=zinger">Zinger robot</a>
    and other projects.
</p>
<p>
    <a href="/about.html">More ...</a>
</p>

                </div>
                <div id="sbox2">
                    <h2>Recent</h2>
                    <ul class="list-unstyled">
                            <li><a href="/posts/Swerve-motion-profiles">Swerve drive - Motion profiles</a></li>
                            <li><a href="/posts/Swerve-drive-control-animations">Swerve drive - Movement animations</a></li>
                            <li><a href="/posts/Swerve-drive-body-focussed-control">Swerve drive - Better movement by controlling the body motions</a></li>
                            <li><a href="/posts/Swerve-drive-kinematics-verification">Swerve drive - Verification of the kinematics solution</a></li>
                            <li><a href="/posts/Swerve-drive-kinematics-simulation">Swerve drive - Kinematics simulation</a></li>
                            <li><a href="/posts/Swerve-drive-introduction">Swerve drive - Moving a robot in all directions, mostly</a></li>
                            <li><a href="/posts/Robotics-fixing-scuttles-encoder">Starting robotics - Fixing the wheel encoders</a></li>
                            <li><a href="/posts/Robotics-a-bumper-for-scuttle-electronics">Starting robotics - Building a bumper for scuttle. The electronics</a></li>
                            <li><a href="/posts/Robotics-a-bumper-for-scuttle-software">Starting robotics - Building a bumper for scuttle. The software</a></li>
                            <li><a href="/posts/Robotics-a-bumper-for-scuttle-overview">Starting robotics - Building a bumper for scuttle. The overview</a></li>
                    </ul>
                </div>
                <div id="sbox3">
                    <h2>Tags</h2>
                    <div>
                        <ul class="list-unstyled">
                                <li>
                                    <a role="button" href="/tags/Robotics" class="btn btn-default btn-sm"> Robotics (14)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Sherlock" class="btn btn-default btn-sm"> Sherlock (13)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/nBuildKit" class="btn btn-default btn-sm"> nBuildKit (12)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/DevOps" class="btn btn-default btn-sm"> DevOps (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Software-development-pipeline" class="btn btn-default btn-sm"> Software development pipeline (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Delivering-software" class="btn btn-default btn-sm"> Delivering software (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/PG2" class="btn btn-default btn-sm"> PG2 (9)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Paragliding" class="btn btn-default btn-sm"> Paragliding (9)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Blog" class="btn btn-default btn-sm"> Blog (7)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Nuclei" class="btn btn-default btn-sm"> Nuclei (6)</a>
                                </li>
                        </ul>
                    </div>
                    <br />
                    <ul class="pager">
                        <li class="next">
                            <a href="/tags">View All Tags &rarr;</a>
                        </li>
                    </ul>
                </div>
            </div>

            <div id="content">

<div id="post">
    <div id="post-header">
        <!--
    Model is: Tuple<IDocument, IDocument>.
    The first one is the current document that is being rendered, the second one is the one for which the post header should be rendered.
-->


<h2>
Creating Azure VM images with Powershell</h2>
<div id="post-meta">
    <div class="meta-date">
Monday, November 10, 2014
 |             Posted in     </div>
    <div class="meta-tags">
                        <a id="post-category" role="button" href="/tags/Azure" class="btn btn-default btn-xs tag-no-wrap">Azure</a>
                        <a id="post-category" role="button" href="/tags/Powershell" class="btn btn-default btn-xs tag-no-wrap">Powershell</a>
    </div>
</div>

    </div>

    <div id="post-content">
        <p>As part of a new <a href="https://github.com/pvandervelde/azure-jenkins">project</a> to create a
<a href="https://jenkins.io">Jenkins CI server</a> on Azure I am writing a set of Powershell scripts to
control virtual machines on Azure. For this project the plan is to use virtual machine (VM) images
as a template for an <a href="https://martinfowler.com/bliki/ImmutableServer.html">&lsquo;immutable server&rsquo;</a> that
will contain the Jenkins instance.</p>
<p>Now the actual server isn't really &lsquo;immutable&rsquo; given that the Jenkins instance will update, add and
delete files on the hard drive which will obviously change the state of the server. As such the immutable
idea isn't applied to the whole server but more to the configuration part of the server. The idea being
that the configuration of the server will not be changed once the server is put in production. Any
configuration changes (e.g. a new version of Jenkins) will be done by creating a new image, spinning
up a new server based on that image and then destroying the old server and replacing it with the
new one.</p>
<p>So in order to achieve this goal the first step will be to build an image with all the required
software on it and then verify that this image has indeed been created correctly.</p>
<p>To create the image we first obtain a certificate that can be used for the WinRM SSL connection between
the Azure VM and the local machine that is executing the creation scripts. You can either get an official
one or you can use a self-signed certificate (which is obviously less secure). Two things of
interest are:</p>
<ul>
<li>The certificate needs to have an <a href="https://consultingblogs.emc.com/gracemollison/archive/2010/02/19/creating-and-using-self-signed-certificates-for-use-with-azure-service-management-api.aspx">exportable</a>
private key because otherwise it cannot be used for the WinRM connection.</li>
<li>The certificate needs to be named after the connection that you expect to make. For a connection to
an Azure VM this will most likely be something like <code>&lt;RESOURCE_GROUP_NAME&gt;.cloudapp.net</code>.</li>
</ul>
<p>Once the certificate is installed in the user certificate store we can create a new virtual machine
from a given base image, e.g. a Windows 2012 R2 server image. The following Powershell function creates
a new windows VM with a WinRM endpoint with the certificate that was created earlier. Note that the
<a href="https://msdn.microsoft.com/en-us/library/dn495254.aspx"><code>New-AzureVM</code></a> function can create resource
and storage groups for the new VM if you don't specify a storage account and a matching resource group.</p>
<script src="https://gist.github.com/pvandervelde/1153f249115780ed2b99.js"></script>
<p>Once the VM is running a new Powershell remote session can be opened to the machine in order to start
the configuration of the machine. Note that this approach only seems to be working for <code>https</code> connections
because the <code>Get-AzureWinRMUri</code> function only returns the <code>https</code> URI. Hence the need for a certificate
that can be used to secure the connection.</p>
<script src="https://gist.github.com/pvandervelde/eb6e28934d5fd16fe186.js"></script>
<p>The next step is to copy all the installer files and configuration scripts to the VM. This can be
done over the <a href="https://measureofchaos.wordpress.com/2012/09/26/copying-files-via-powershell-remoting-channel/">remoting channel</a>.</p>
<script src="https://gist.github.com/pvandervelde/b2f5b4156e5efe67f495.js"></script>
<p>Once all the required files have been copied to the VM the configuration of the machine can be started.
This can be done in many different ways, e.g through the use of a <a href="https://www.getchef.com/">configuration</a>
<a href="https://puppetlabs.com/">management</a> <a href="https://technet.microsoft.com/en-us/library/dn249912.aspx">tool</a>
or just via the use of plain old scripts. When the configuration is complete and all the necessary
clean-up has been done the time has come to turn the VM into an image. Before doing that a Windows
machine will have to be <a href="https://en.wikipedia.org/wiki/Sysprep">sysprepp'ed</a> so that there are no
unique identifiers in the image (and thus in the copies).</p>
<p>In order to sysprep an Azure VM it is necessary to execute the sysprep command through a script on the
VM because sysprep <a href="https://blogs.msdn.com/b/brocode/archive/2014/06/20/how-to-automate-sysprep-of-an-iaas-vm-on-microsoft-azure.aspx">fails</a>
if the command is given directly through the remoting channel. The following function creates a new
Powershell script which invokes sysprep, copies that to the VM and then executes that script. Once
sysprep has completed running the machine will be turned off and an image can be created.</p>
<script src="https://gist.github.com/pvandervelde/b2f5b4156e5efe67f495.js"></script>
<p>The next step is to test the new image in order to verify that all configuration changes have been
applied correctly. The explanation of how the testing of an virtual machine image works is a topic
for the next blog post.</p>

    </div>

    <div id="post-footer">
        <div>
    <div class="navlinks">
                <a href="/posts/Building-and-delivering-nBuildKit-with-AppVeyor" title="Previous Post: Building and delivering nBuildKit with AppVeyor" class="navlinks-prev">« Building and delivering nBuildKit with AppVeyor</a>
                <a href="/posts/nBuildKit-release-V041" title="Next Post: nBuildKit release - V0.4.1" class="navlinks-next">nBuildKit release - V0.4.1 »</a>
    </div>
</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mindvortex'; // required: replace example with your forum shortname
    var disqus_identifier = 'Creating-azure-vm-images-with-powershell';
    var disqus_title = 'Creating Azure VM images with Powershell';
    var disqus_url = 'https://www.petrikvandervelde.nl/posts/Creating-azure-vm-images-with-powershell';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>
</div>







            </div>
        </div>

        <footer>
            <div id="footer" class="container">
    <div id="fbox1">
        <h2>Related</h2>
        <ul>
            <li><a href="https://github.com/pvandervelde"><i class="fa fa-github"></i> GitHub</a></li>
            <li><a href="https://www.linkedin.com/profile/view?id=33950311"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
            <li><a href="https://stackoverflow.com/users/539846/petrik"><i class="fa fa-stack-overflow"></i> StackOverflow</a></li>
            <li><a href="https://careers.stackoverflow.com/pvandervelde"><i class="fa fa-stack-overflow"></i> StackOverflow Careers</a></li>
            <li><a href="https://profile.codersrank.io/user/pvandervelde">CodersRank</a></li>
        </ul>
    </div>
    <div id="fbox2">
        <h2 id="copyright">Copyright</h2>
        <p>Copyright (c) 2023 <a href="/">Petrik van der Velde</a>. All rights reserved.</p>

        <h2 id="disclaimer">Disclaimer</h2>
        <p>The opinions expressed herein are my own personal opinions and do not represent my employer's view in any way.</p>
    </div>
    <div id="fbox3">
        <h2 id="media">Media</h2>
        <p><a href="/feed.atom"><img src="/assets/images/feed.png" alt="Atom feed"></a></p>
    </div>
</div>
<div id="copyright" class="container">
    <div>
        <p>
            Generated by <a href="https://wyam.io">Wyam</a> on Tue, 19 Dec 2023 08:42:04 GMT

 from commit <a href="https://github.com/pvandervelde/mindvortex/tree/62e03cf296efd5a2e3a66d34466a67667e7f93af">62e03cf296efd5a2e3a66d34466a67667e7f93af</a> at version 3.17.1.        </p>
    </div>

    <p>
        Site design based on the <a href="https://www.freecsstemplates.org/previews/opentools/">Open Tools</a> design
        by <a href="https://www.freecsstemplates.org">FreeCSSTemplates.org</a>.
    </p>
    <p>
        Feed icon by <a href="https://www.icojam.com/">Icojam</a> and Favicon by
        <a href="https://www.flaticon.com/free-icon/twister-sky-wind_12318" title="Yannick">Yannick</a>
        from <a href="https://www.flaticon.com" title="Flaticon">www.flaticon.com</a>
    </p>
</div>

        </footer>
    </body>
</html>
