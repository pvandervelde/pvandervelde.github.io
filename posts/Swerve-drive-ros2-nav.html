
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Mind vortex - Swerve drive - Using Nav2</title>
        <meta name="description" content="Welcome!" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Mind vortex" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Mind vortex" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/normalize.css" rel="stylesheet" />
        <link href="/assets/css/h5bp.css" rel="stylesheet">
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
        <link href="/assets/css/override.css" rel="stylesheet" />
        <link href="/assets/css/github.css" rel="stylesheet" type="text/css">

        <script src="https://fred-wang.github.io/TeXZilla/TeXZilla-min.js"></script>
        <script src="https://fred-wang.github.io/TeXZilla/examples/customElement.js"></script>
        <link href="https://fred-wang.github.io/MathFonts/Asana/mathfonts.css" rel="stylesheet" />

        <meta name="application-name" content="Mind vortex" />
        <meta name="msapplication-tooltip" content="Mind vortex" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Mind vortex - Swerve drive - Using Nav2" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://www.petrikvandervelde.nl/posts/Swerve-drive-ros2-nav" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>
        <script src="/assets/js/highlight.pack.js"></script>
        <script src="/assets/js/clean-blog.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

        <!-- Our scripts -->
<script src="/assets/js/script.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DV643VJGFT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DV643VJGFT');
</script>


    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->
        <div id="header" class="container">
            <div id="logo">
                <h1><a href="/">Mind vortex</a></h1>
            </div>
            <div id="menu">
                <ul>
                            <!-- Pages -->
        <!-- BlogPosts -->
        <!-- Tags -->
        <!-- TagIndex -->
        <!-- BlogArchive -->
        <!-- Index -->
        <!-- RenderTagIndex -->
        <!-- RenderTags -->
        <!-- RenderBlogArchive -->
        <!-- Feed -->
        <!-- RenderBlogPosts -->
    <!-- Context.Documents['Pages'] -->
        <!-- 404 Not Found - False - /404 -->
        <!-- About - True - /about -->
        <!-- Projects - True - /projects -->
        <!-- Robotics - False - /projects/robotics -->
        <!-- Scuttle - False - /projects/scuttle -->
        <!-- Zinger - False - /projects/zinger -->
            <li class="inactive" >
                <a href="/">Home</a>
            </li>
            <li class="inactive" >
                <a href="/projects">Projects</a>
            </li>
            <li class="inactive" >
                <a href="/posts">Archive</a>
            </li>
            <li class="inactive" >
                <a href="/tags">Tags</a>
            </li>
            <li class="inactive" >
                <a href="/about">About</a>
            </li>

                </ul>
            </div>
        </div>

        <div id="page" class="container">
            <div id="sidebar">
                <div id="sbox1">
                    <h2>Patrick van der Velde</h2>

<p>
    <img src="https://www.gravatar.com/avatar/9bc8b3ff385cd14f2b12138c97729df2?s=160"
        alt="Gravatar for Patrick van der Velde">
</p>
<p>
    I am a senior lead software engineer who is living, working and playing in New Zealand.
    Developer of the <a href="/tags/Zinger">Zinger robot</a>, contributor on the
    <a href="/tags/Scuttle">Scuttle project</a>.

    In my spare time wood worker, rock climber, gardner.
</p>
<p>
    <a href="/about.html">More ...</a>
</p>

                </div>
                <div id="sbox2">
                    <h2>Recent</h2>
                    <ul class="list-unstyled">
                            <li><a href="/posts/Swerve-drive-motor-limitations">Swerve drive - Motor limitations</a></li>
                            <li><a href="/posts/Swerve-drive-ros2-nav">Swerve drive - Using Nav2</a></li>
                            <li><a href="/posts/Robotics-making-urdf-models">Robotics - Making URDF models</a></li>
                            <li><a href="/posts/Swerve-motion-profiles">Swerve drive - Motion profiles</a></li>
                            <li><a href="/posts/Swerve-drive-control-animations">Swerve drive - Movement animations</a></li>
                            <li><a href="/posts/Swerve-drive-body-focussed-control">Swerve drive - Better movement by controlling the body motions</a></li>
                            <li><a href="/posts/Swerve-drive-kinematics-verification">Swerve drive - Verification of the kinematics solution</a></li>
                            <li><a href="/posts/Swerve-drive-kinematics-simulation">Swerve drive - Kinematics simulation</a></li>
                            <li><a href="/posts/Swerve-drive-introduction">Swerve drive - Moving a robot in all directions, mostly</a></li>
                            <li><a href="/posts/Robotics-fixing-scuttles-encoder">Starting robotics - Fixing the wheel encoders</a></li>
                    </ul>
                </div>
                <div id="sbox3">
                    <h2>Tags</h2>
                    <div>
                        <ul class="list-unstyled">
                                <li>
                                    <a role="button" href="/tags/Robotics" class="btn btn-default btn-sm"> Robotics (17)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Sherlock" class="btn btn-default btn-sm"> Sherlock (13)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/nBuildKit" class="btn btn-default btn-sm"> nBuildKit (12)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Software-development-pipeline" class="btn btn-default btn-sm"> Software development pipeline (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Delivering-software" class="btn btn-default btn-sm"> Delivering software (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/DevOps" class="btn btn-default btn-sm"> DevOps (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/PG2" class="btn btn-default btn-sm"> PG2 (9)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Paragliding" class="btn btn-default btn-sm"> Paragliding (9)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Zinger" class="btn btn-default btn-sm"> Zinger (8)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Omnidirectional" class="btn btn-default btn-sm"> Omnidirectional (8)</a>
                                </li>
                        </ul>
                    </div>
                    <br />
                    <ul class="pager">
                        <li class="next">
                            <a href="/tags">View All Tags &rarr;</a>
                        </li>
                    </ul>
                </div>
            </div>

            <div id="content">

<div id="post">
    <div id="post-header">
        <!--
    Model is: Tuple<IDocument, IDocument>.
    The first one is the current document that is being rendered, the second one is the one for which the post header should be rendered.
-->


<h2>
Swerve drive - Using Nav2</h2>
<div id="post-meta">
    <div class="meta-date">
Wednesday, January 17, 2024
 |             Posted in     </div>
    <div class="meta-tags">
                        <a id="post-category" role="button" href="/tags/Nav2" class="btn btn-default btn-xs tag-no-wrap">Nav2</a>
                        <a id="post-category" role="button" href="/tags/Omnidirectional" class="btn btn-default btn-xs tag-no-wrap">Omnidirectional</a>
                        <a id="post-category" role="button" href="/tags/Robotics" class="btn btn-default btn-xs tag-no-wrap">Robotics</a>
                        <a id="post-category" role="button" href="/tags/ROS2" class="btn btn-default btn-xs tag-no-wrap">ROS2</a>
                        <a id="post-category" role="button" href="/tags/Swerve" class="btn btn-default btn-xs tag-no-wrap">Swerve</a>
                        <a id="post-category" role="button" href="/tags/Zinger" class="btn btn-default btn-xs tag-no-wrap">Zinger</a>
    </div>
</div>

    </div>

    <div id="post-content">
        <p>The <a href="/posts/Swerve-drive-introduction">goals for the development of my swerve drive robot</a> were to
develop an off-road capable robot that can navigate autonomously between different locations to
execute tasks either by itself or in cooperation with other robots. So far I have implemented the
first version of the <a href="/posts/Swerve-drive-body-focussed-control">steering and drive controller</a>,
added <a href="/posts/Swerve-motion-profiles">motion profiles</a> for smoother changes in velocity and acceleration,
and I have created the <a href="/posts/Robotics-making-urdf-models">URDF files</a> that allow me to simulate the
robot in Gazebo. The next part is to add the ability to navigate the robot, autonomously,
to a goal location.</p>
<p>So how does the navigation in general work? The first step is to figure out where the robot is, or
at least what is around the robot. Using the robot sensors, e.g. a lidar, we can see what the direct
environment looks like, e.g. the robot is in a room of a building. If we have a map of the larger
environment, e.g. the building, then using a <a href="https://github.com/ros-planning/navigation2/tree/main/nav2_amcl">location algorithm</a>
we can figure out where in the building we are. Assuming there are enough features in the
room to make it obvious which room we are in. If we don't have a map of the environment then we can
use a <a href="https://en.wikipedia.org/wiki/Simultaneous_localization_and_mapping">SLAM</a> algorithm to create
a map while the robot is moving. Having a map makes planning more reliable, because we can plan a
path that takes into account the surroundings. However it is not strictly necessary, we can also
plan a path without a map, but then it is possible that the planner will plan a path that is not
possible to follow, e.g. because there is a wall in the way. Of course if there are dynamic obstacles,
e.g. if a door is closed, then the map might not be accurate and we might still not be able to get
to the goal.</p>
<p>Once the robot knows where it is and it has a goal location, it can plan a path from the current
location to the goal location. This is generally done by a <a href="https://navigation.ros.org/concepts/index.html#planners">global planner or planner for short</a>.
There are many different algorithms for path planning each with their own advantages and disadvantages.
Most planners only plan a path, consisting of a number of waypoints, from the current location to
the goal location. More advanced planners can also provide velocity information along the path,
turning the path into a trajectory for the robot to follow. Once a path, or trajectory, is created
the robot can follow this path to reach the goal. For this a <a href="https://navigation.ros.org/concepts/index.html#controllers">local planner or controller</a>
is used. The controller works to make the robot follow the path while making progress towards
the goal and avoiding obstacles. Again there are a number of different algorithms, each with it own
constraints.</p>
<p>Note that robot navigation is a very complex topic that is very actively being researched. A result
of this is that there are many ways in which navigation can fail or not work as expected. For example
some of the issues I have seen are:</p>
<ul>
<li>The planner is unable to find a path to the goal. This can happen when there is no actual way to
get to the goal, e.g. the robot is in a room with a closed door with the goal outside the room.
Or when the path would pass through a section that is too narrow for the robot to fit through.</li>
<li>The controller is unable to follow path created by the planner, most likely because the path is not
kinematically possible for the robot. For example the path might require the robot to turn in place
when it is using an Ackerman steering system. Or the path requires the robot to pass through a
narrow space that the controller deems to narrow.</li>
<li>The robot gets stuck in a corner or hallway. It considers the hallway too narrow to fit
through safely or has no way to perform the directional changes it wants to make. Sometimes this is
caused by the robot being too wide. However most of the cases I have seen it in is caused by the
planner configuration.</li>
<li>The robot is slow to respond to movement commands, leading to ever larger commanded steering and velocities.
This was mostly an issue with the DWB controller, the MPPI controller seems to be more responsive.
However there is definitely an issue with the swerve controller code that I need to investigate.</li>
<li>The VM I was running the simulation on wasn't quick enough to run the simulation close to real time.
So at some point I need to switch to running on a desktop.</li>
</ul>
<p>And these are only the ones I have seen. There are many more ways in which the navigation can fail.
So it pays to stay up to date with the latest developments and to ensure that you have good ways
to test and debug your robot and the navigation stack.</p>
<p>Now that we know roughly what is needed for successful navigation let's have a look at what is
needed for the swerve drive robot. The first thing we need is a way to figure out where we are. Because
I don't have a map of the environment I am using an online SLAM approach, which creates the map
as the robot moves around the area. The <a href="https://github.com/SteveMacenski/slam_toolbox">slam_toolbox</a>
package makes this easy. The  <a href="https://github.com/pvandervelde/zinger_nav/blob/master/config/slam.yaml">configuration</a>
for the robot is mostly the default configuration, except for the changes required to match the URDF
model.</p>
<p>For the navigation I am using the <a href="https://navigation.ros.org/">Nav2</a> package. From that package I
selected the <a href="https://github.com/ros-planning/navigation2/tree/main/nav2_smac_planner">SMAC lattice</a>
for the planner and the <a href="https://github.com/ros-planning/navigation2/tree/main/nav2_mppi_controller">MPPI</a>
controller. These two were selected because they both support omnidirectional movement for non-circular,
arbitrary shaped robots. The omnidirectional movement is required because the swerve drive robot
can move in all directions and it would be a waste not to use that capability. The non-circular robot
comes from the fact that the robot is rectangular and could pass through narrow passages in one
orientation but not the other. Originally I tried the
<a href="https://github.com/ros-planning/navigation2/tree/main/nav2_dwb_controller">DWB controller</a>
and the <a href="https://github.com/ros-planning/navigation2/tree/main/nav2_navfn_planner">navfn planner</a>.
Both are said to support omnidirectional movement. But when applied the DWB planner didn't really
use the omnidirectional capabilities. Additionally it gets stuck for certain movements for unknown
reasons. Once I changed to using the SMAC planner and the MPPI controller the robot was successfully
able to navigate around the environment.
Again the <a href="https://github.com/pvandervelde/zinger_nav/blob/master/config/nav2.yaml">configuration</a>
is mostly the default configuration except that I have updated some of the values to match the robot's
capabilities.</p>
<iframe
    style="float:none"
    width="560"
    height="315"
    src="https://www.youtube.com/embed/U2IOLwuCvrQ"
    title="YouTube video player"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
    allowfullscreen>
</iframe>
<p>With all that set I got the robot to navigate to a goal. The video shows the robot starting the navigation
from one room to another. As it moves at the <a href="https://youtu.be/U2IOLwuCvrQ?t=15">15 second</a> mark it
starts sideways translating while rotating to get around the corner in order to get through the door
of the room. It continues its journey mostly traversing sideways, occasionally rotating into the
direction it is moving. At the <a href="https://youtu.be/U2IOLwuCvrQ?t=52">52 second</a>
mark it reaches the goal location and rotates into the orientation it was commanded to
end up in. Note that the planner inserted a turn, stop and back-up segment to get to the right
orientation but the local planner opted to perform an in-place rotation at the end.</p>
<p>While there was a bit of tuning required to get the SLAM and navigation stacks to work, in the
end it worked well. Obviously this is only one test case so once I have a dedicated PC to run
the simulation I am going to do a lot more testing.</p>
<p>One of the things that is currently not implemented is limits on the steering and drive velocities.
This means that currently the robot can move at any speed and turn at any rate. This is not
realistic and will in the real world lead to the motors in the robot being overloaded. So the
next step is to add the limits to the controller. The main issue with this is the need to keep the
drive modules synchronised. So when one of the modules exceeds its velocity limits the other modules
have to be slowed down as well so that we don't lose synchronisation between the modules. More on this
in one of my next posts.</p>

    </div>

    <div id="post-footer">
        <div>
    <div class="navlinks">
                <a href="/posts/Robotics-making-urdf-models" title="Previous Post: Robotics - Making URDF models" class="navlinks-prev">« Robotics - Making URDF models</a>
                <a href="/posts/Swerve-drive-motor-limitations" title="Next Post: Swerve drive - Motor limitations" class="navlinks-next">Swerve drive - Motor limitations »</a>
    </div>
</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mindvortex'; // required: replace example with your forum shortname
    var disqus_identifier = 'Swerve-drive-ros2-nav';
    var disqus_title = 'Swerve drive - Using Nav2';
    var disqus_url = 'https://www.petrikvandervelde.nl/posts/Swerve-drive-ros2-nav';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>
</div>







            </div>
        </div>

        <footer>
            <div id="footer" class="container">
    <div id="fbox1">
        <h2>Related</h2>
        <ul>
            <li><a href="https://github.com/pvandervelde"><i class="fa fa-github"></i> GitHub</a></li>
            <li><a href="https://www.linkedin.com/profile/view?id=33950311"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
            <li><a href="https://stackoverflow.com/users/539846/petrik"><i class="fa fa-stack-overflow"></i> StackOverflow</a></li>
            <li><a href="https://careers.stackoverflow.com/pvandervelde"><i class="fa fa-stack-overflow"></i> StackOverflow Careers</a></li>
            <li><a href="https://profile.codersrank.io/user/pvandervelde">CodersRank</a></li>
        </ul>
    </div>
    <div id="fbox2">
        <h2 id="copyright">Copyright</h2>
        <p>Copyright (c) 2024 <a href="/">Petrik van der Velde</a>. All rights reserved.</p>

        <h2 id="disclaimer">Disclaimer</h2>
        <p>The opinions expressed herein are my own personal opinions and do not represent my employer's view in any way.</p>
    </div>
    <div id="fbox3">
        <h2 id="media">Media</h2>
        <p><a href="/feed.atom"><img src="/assets/images/feed.png" alt="Atom feed"></a></p>
    </div>
</div>
<div id="copyright" class="container">
    <div>
        <p>
            Generated by <a href="https://wyam.io">Wyam</a> on Thu, 22 Feb 2024 09:15:58 GMT

 from commit <a href="https://github.com/pvandervelde/mindvortex/tree/8f0cb31f2b7d5b06ebc24f0520faedafad19887e">8f0cb31f2b7d5b06ebc24f0520faedafad19887e</a> at version 3.20.0.        </p>
    </div>

    <p>
        Site design based on the <a href="https://www.freecsstemplates.org/previews/opentools/">Open Tools</a> design
        by <a href="https://www.freecsstemplates.org">FreeCSSTemplates.org</a>.
    </p>
    <p>
        Feed icon by <a href="https://www.icojam.com/">Icojam</a> and Favicon by
        <a href="https://www.flaticon.com/free-icon/twister-sky-wind_12318" title="Yannick">Yannick</a>
        from <a href="https://www.flaticon.com" title="Flaticon">www.flaticon.com</a>
    </p>
</div>

        </footer>
    </body>
</html>
