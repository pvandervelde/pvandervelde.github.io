
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Mind vortex - Updating my Hyper-V server to Windows 2016</title>
        <meta name="description" content="Welcome!" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Mind vortex" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Mind vortex" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/normalize.css" rel="stylesheet" />
        <link href="/assets/css/h5bp.css" rel="stylesheet">
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
        <link href="/assets/css/override.css" rel="stylesheet" />
        <link href="/assets/css/github.css" rel="stylesheet" type="text/css">


        <meta name="application-name" content="Mind vortex" />
        <meta name="msapplication-tooltip" content="Mind vortex" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Mind vortex - Updating my Hyper-V server to Windows 2016" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://www.petrikvandervelde.nl/posts/Updating-Hyper-v-server-to-Windows2016" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>
        <script src="/assets/js/highlight.pack.js"></script>
        <script src="/assets/js/clean-blog.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

        <!-- Our scripts -->
<script src="/assets/js/script.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DV643VJGFT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DV643VJGFT');
</script>


    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->
        <div id="header" class="container">
            <div id="logo">
                <h1><a href="/">Mind vortex</a></h1>
            </div>
            <div id="menu">
                <ul>
                            <!-- Pages -->
        <!-- BlogPosts -->
        <!-- Tags -->
        <!-- TagIndex -->
        <!-- BlogArchive -->
        <!-- Index -->
        <!-- RenderTagIndex -->
        <!-- RenderTags -->
        <!-- RenderBlogArchive -->
        <!-- Feed -->
        <!-- RenderBlogPosts -->
    <!-- Context.Documents['Pages'] -->
        <!-- 404 Not Found - False - /404 -->
        <!-- About - True - /about -->
        <!-- Projects - True - /projects -->
        <!-- Robotics - False - /projects/robotics -->
        <!-- Scuttle - False - /projects/scuttle -->
            <li class="inactive" >
                <a href="/">Home</a>
            </li>
            <li class="inactive" >
                <a href="/projects">Projects</a>
            </li>
            <li class="inactive" >
                <a href="/posts">Archive</a>
            </li>
            <li class="inactive" >
                <a href="/tags">Tags</a>
            </li>
            <li class="inactive" >
                <a href="/about">About</a>
            </li>

                </ul>
            </div>
        </div>

        <div id="page" class="container">
            <div id="sidebar">
                <div id="sbox1">
                    <h2>Patrick van der Velde</h2>

<p>
    <img src="https://www.gravatar.com/avatar/9bc8b3ff385cd14f2b12138c97729df2?s=160" alt="Gravatar for Patrick van der Velde">
</p>
<p>
    Dutch software developer who is living, working and playing in New Zealand.
    Rock climber and paragliding pilot. Developer of
    <a href="https://nbuildkit.github.io/nBuildKit.MsBuild/">nBuildKit</a>,
    <a href="https://github.com/Calvinverse">the Calvinverse resources</a> and other projects.
</p>
<p>
    <a href="/about.html">More ...</a>
</p>

                </div>
                <div id="sbox2">
                    <h2>Recent</h2>
                    <ul class="list-unstyled">
                            <li><a href="/posts/Swerve-drive-control-animations">Swerve drive - Movement animations</a></li>
                            <li><a href="/posts/Swerve-drive-body-focussed-control">Swerve drive - Better movement by controlling the body motions</a></li>
                            <li><a href="/posts/Swerve-drive-kinematics-verification">Swerve drive - Verification of the kinematics solution</a></li>
                            <li><a href="/posts/Swerve-drive-kinematics-simulation">Swerve drive - Kinematics simulation</a></li>
                            <li><a href="/posts/Swerve-drive-introduction">Swerve drive - Moving a robot in all directions, mostly</a></li>
                            <li><a href="/posts/Robotics-fixing-scuttles-encoder">Starting robotics - Fixing the wheel encoders</a></li>
                            <li><a href="/posts/Robotics-a-bumper-for-scuttle-electronics">Starting robotics - Building a bumper for scuttle. The electronics</a></li>
                            <li><a href="/posts/Robotics-a-bumper-for-scuttle-software">Starting robotics - Building a bumper for scuttle. The software</a></li>
                            <li><a href="/posts/Robotics-a-bumper-for-scuttle-overview">Starting robotics - Building a bumper for scuttle. The overview</a></li>
                            <li><a href="/posts/Robotics-driving-scuttle-with-ros-gazebo-simulation">Starting robotics - Driving scuttle with ROS - Gazebo simulation</a></li>
                    </ul>
                </div>
                <div id="sbox3">
                    <h2>Tags</h2>
                    <div>
                        <ul class="list-unstyled">
                                <li>
                                    <a role="button" href="/tags/Sherlock" class="btn btn-default btn-sm"> Sherlock (13)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Robotics" class="btn btn-default btn-sm"> Robotics (13)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/nBuildKit" class="btn btn-default btn-sm"> nBuildKit (12)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Software-development-pipeline" class="btn btn-default btn-sm"> Software development pipeline (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Delivering-software" class="btn btn-default btn-sm"> Delivering software (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/DevOps" class="btn btn-default btn-sm"> DevOps (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/PG2" class="btn btn-default btn-sm"> PG2 (9)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Paragliding" class="btn btn-default btn-sm"> Paragliding (9)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Blog" class="btn btn-default btn-sm"> Blog (7)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Scuttle" class="btn btn-default btn-sm"> Scuttle (6)</a>
                                </li>
                        </ul>
                    </div>
                    <br />
                    <ul class="pager">
                        <li class="next">
                            <a href="/tags">View All Tags &rarr;</a>
                        </li>
                    </ul>
                </div>
            </div>

            <div id="content">

<div id="post">
    <div id="post-header">
        <!--
    Model is: Tuple<IDocument, IDocument>.
    The first one is the current document that is being rendered, the second one is the one for which the post header should be rendered.
-->


<h2>
Updating my Hyper-V server to Windows 2016</h2>
<div id="post-meta">
    <div class="meta-date">
Saturday, March 18, 2017
 |             Posted in     </div>
    <div class="meta-tags">
                        <a id="post-category" role="button" href="/tags/Hyper-V" class="btn btn-default btn-xs tag-no-wrap">Hyper-V</a>
                        <a id="post-category" role="button" href="/tags/Windows2016" class="btn btn-default btn-xs tag-no-wrap">Windows2016</a>
    </div>
</div>

    </div>

    <div id="post-content">
        <p>One of the computers I have in my home is a Hyper-V server which I use to experiment with all things
virtual machines, e.g. <a href="https://www.thoughtworks.com/insights/blog/infrastructure-code-reason-smile">infrastructure-as-code</a>.
This server was until recently running Windows 2012R2 with the associated version of Hyper-V. With
the release of Windows 2016 a new version of Hyper-V was available which had some interesting
features, like <a href="https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/user-guide/nested-virtualization">nested virtualization</a>
which allows running VMs on VMs and running Hyper-V containers. All in all enough interesting features
to warrant upgrading my server.</p>
<p>There are however some issues to deal with. The first one being, which version of Windows 2016 are
we going to install? The ideal version to install would be the <a href="https://technet.microsoft.com/en-us/hyper-v-server-docs/hyper-v-server-2016?f=255&amp;MSPPError=-2147217396">bare metal Hyper-V</a>
option with <a href="https://technet.microsoft.com/en-us/windows-server-docs/get-started/windows-server-2016">Windows 2016 server Core</a>
being the second best option. The problem with these version is that it might be harder to
configure the network and attach the machine to the active directory. I currently don't have enough
experience managing Windows through (remote) Powershell in order to be able to resolve those kinds
of issues without a large amount of help from Google or Bing. The goal for this exercise is to get
the machine updated so that we can use it, not to get the most lean version of Windows installed, so
I opted to go for the full GUI version of Windows 2016.</p>
<p>To make things more interesting my Active Directory server is a VM running on the Hyper-V server.
And yes I know there should be at least two Active Directory servers on different physical machines
but until I have lots of money and can afford to have multiple servers in my house I will work
with having a single AD server.</p>
<p>The approach I followed to upgrade the operating system on my server to Windows 2016 was as follows.</p>
<ul>
<li>Make backups of everything and be ready to spend some time restoring the AD server, i.e. this is
probably better done as a weekend job.</li>
<li>Create a <a href="https://www.microsoft.com/en-us/download/windows-usb-dvd-download-tool">bootable USB</a>
with the Windows2016 installer.</li>
<li>Attach a keyboard, mouse and monitor to the server so that we can log in to the server directly.
Installing Windows remotely is not possible with my local configuration.</li>
<li>Insert the USB drive, reboot the server and make sure it boots from the USB key</li>
<li>After the Windows installation starts make sure to remove the existing partitions on the original
OS drive. While the OS could be upgraded that also leaves a lot of unused files around. Unfortunately
in that case it will be hard to determine if these files can be deleted or not. By doing a clean
install we can be sure that there will not be any left-overs from the upgrade.</li>
</ul>
<p>Once the new operating system is installed the next step is to restore the VMs. Because all the
VM information was stored on physically different disks than the OS disk all the virtual hard drives
and VM configuration files still exist. In this case it is easy to import the old virtual machines
via the Hyper-V manager.</p>
<p>Once all the VMs were up and running again the last step was to attach the Hyper-V machine to the
domain so that it is easy to use the remote desktop capabilities. Now attaching the machine to
the domain is easy, the problem occurs when you have to restart the Hyper-V machine because after
the reboot the network connection will be set to the public profile instead of the domain profile
which means remote desktop and friends are all blocked. This is all caused by the fact that when the
Hyper-V machine boots up it doesn't have connection to the AD server, because that is a VM running
on the Hyper-V machine, and thus the network profile is set to be public for security purposes.</p>
<p>In order to fix this we need to either force the <a href="https://newsignature.com/articles/network-location-awareness-service-can-ruin-day-fix/">Network Location Awareness service</a> to run
after the AD server has started, or we need to restart the service after a short period. In my case
setting the service start in delayed mode didn't really work so I created a scheduled task which
restarted the service by calling the following command line</p>
<pre><code>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -noprofile -nologo -command &quot;restart-service nlasvc -force&quot;
</code></pre>
<p>Over all the upgrade was easier than I thought and there were only minor set backs. Some of the lessons
that were learned are:</p>
<ul>
<li>Ideally for jobs like this you would have an extra keyboard, mouse and monitor around, that way you
can still use the normal PC for googling issues that you come across.</li>
<li>Importing old VMs in Hyper-V is easy as long as you make sure that you know where all the files
are.</li>
<li>Ideally you would have multiple AD servers, running of different physical machines. Then again
ideally I'd also have lots of money to pay for all these physical machines 😉</li>
</ul>

    </div>

    <div id="post-footer">
        <div>
    <div class="navlinks">
                <a href="/posts/Blog-publishing-with-AppVeyor" title="Previous Post: Blog publishing with AppVeyor" class="navlinks-prev">« Blog publishing with AppVeyor</a>
                <a href="/posts/nBuildKit-release-V090" title="Next Post: nBuildKit release - V0.9.0" class="navlinks-next">nBuildKit release - V0.9.0 »</a>
    </div>
</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mindvortex'; // required: replace example with your forum shortname
    var disqus_identifier = 'Updating-Hyper-v-server-to-Windows2016';
    var disqus_title = 'Updating my Hyper-V server to Windows 2016';
    var disqus_url = 'https://www.petrikvandervelde.nl/posts/Updating-Hyper-v-server-to-Windows2016';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>
</div>







            </div>
        </div>

        <footer>
            <div id="footer" class="container">
    <div id="fbox1">
        <h2>Related</h2>
        <ul>
            <li><a href="https://github.com/pvandervelde"><i class="fa fa-github"></i> GitHub</a></li>
            <li><a href="https://www.linkedin.com/profile/view?id=33950311"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
            <li><a href="https://stackoverflow.com/users/539846/petrik"><i class="fa fa-stack-overflow"></i> StackOverflow</a></li>
            <li><a href="https://careers.stackoverflow.com/pvandervelde"><i class="fa fa-stack-overflow"></i> StackOverflow Careers</a></li>
            <li><a href="https://profile.codersrank.io/user/pvandervelde">CodersRank</a></li>
        </ul>
    </div>
    <div id="fbox2">
        <h2 id="copyright">Copyright</h2>
        <p>Copyright (c) 2023 <a href="/">Petrik van der Velde</a>. All rights reserved.</p>

        <h2 id="disclaimer">Disclaimer</h2>
        <p>The opinions expressed herein are my own personal opinions and do not represent my employer's view in any way.</p>
    </div>
    <div id="fbox3">
        <h2 id="media">Media</h2>
        <p><a href="/feed.atom"><img src="/assets/images/feed.png" alt="Atom feed"></a></p>
    </div>
</div>
<div id="copyright" class="container">
    <div>
        <p>
            Generated by <a href="https://wyam.io">Wyam</a> on Tue, 04 Jul 2023 07:41:19 GMT

 from commit <a href="https://github.com/pvandervelde/mindvortex/tree/55209da17204c70cd1b66b22b4b7eea7f4d6946a">55209da17204c70cd1b66b22b4b7eea7f4d6946a</a> at version 3.16.0.        </p>
    </div>

    <p>
        Site design based on the <a href="https://www.freecsstemplates.org/previews/opentools/">Open Tools</a> design
        by <a href="https://www.freecsstemplates.org">FreeCSSTemplates.org</a>.
    </p>
    <p>
        Feed icon by <a href="https://www.icojam.com/">Icojam</a> and Favicon by
        <a href="https://www.flaticon.com/free-icon/twister-sky-wind_12318" title="Yannick">Yannick</a>
        from <a href="https://www.flaticon.com" title="Flaticon">www.flaticon.com</a>
    </p>
</div>

        </footer>
    </body>
</html>
