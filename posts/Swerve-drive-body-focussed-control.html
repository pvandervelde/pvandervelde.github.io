
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Mind vortex - Swerve drive - Better movement by controlling the body motions</title>
        <meta name="description" content="Welcome!" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Mind vortex" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Mind vortex" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/normalize.css" rel="stylesheet" />
        <link href="/assets/css/h5bp.css" rel="stylesheet">
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
        <link href="/assets/css/override.css" rel="stylesheet" />
        <link href="/assets/css/github.css" rel="stylesheet" type="text/css">

        <script src="https://fred-wang.github.io/TeXZilla/TeXZilla-min.js"></script>
        <script src="https://fred-wang.github.io/TeXZilla/examples/customElement.js"></script>
        <link href="https://fred-wang.github.io/MathFonts/Asana/mathfonts.css" rel="stylesheet" />

        <meta name="application-name" content="Mind vortex" />
        <meta name="msapplication-tooltip" content="Mind vortex" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Mind vortex - Swerve drive - Better movement by controlling the body motions" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://www.petrikvandervelde.nl/posts/Swerve-drive-body-focussed-control" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>
        <script src="/assets/js/highlight.pack.js"></script>
        <script src="/assets/js/clean-blog.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

        <!-- Our scripts -->
<script src="/assets/js/script.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DV643VJGFT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DV643VJGFT');
</script>


    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->
        <div id="header" class="container">
            <div id="logo">
                <h1><a href="/">Mind vortex</a></h1>
            </div>
            <div id="menu">
                <ul>
                            <!-- Pages -->
        <!-- BlogPosts -->
        <!-- Tags -->
        <!-- TagIndex -->
        <!-- BlogArchive -->
        <!-- Index -->
        <!-- RenderTagIndex -->
        <!-- RenderTags -->
        <!-- RenderBlogArchive -->
        <!-- Feed -->
        <!-- RenderBlogPosts -->
    <!-- Context.Documents['Pages'] -->
        <!-- 404 Not Found - False - /404 -->
        <!-- About - True - /about -->
        <!-- Projects - True - /projects -->
        <!-- Robotics - False - /projects/robotics -->
        <!-- Scuttle - False - /projects/scuttle -->
        <!-- Zinger - False - /projects/zinger -->
            <li class="inactive" >
                <a href="/">Home</a>
            </li>
            <li class="inactive" >
                <a href="/projects">Projects</a>
            </li>
            <li class="inactive" >
                <a href="/posts">Archive</a>
            </li>
            <li class="inactive" >
                <a href="/tags">Tags</a>
            </li>
            <li class="inactive" >
                <a href="/about">About</a>
            </li>

                </ul>
            </div>
        </div>

        <div id="page" class="container">
            <div id="sidebar">
                <div id="sbox1">
                    <h2>Patrick van der Velde</h2>

<p>
    <img src="https://www.gravatar.com/avatar/9bc8b3ff385cd14f2b12138c97729df2?s=160"
        alt="Gravatar for Patrick van der Velde">
</p>
<p>
    I am a senior lead software engineer who is living, working and playing in New Zealand.
    Developer of the <a href="/tags/Zinger">Zinger robot</a>, contributor on the
    <a href="/tags/Scuttle">Scuttle project</a>.

    In my spare time wood worker, rock climber, gardner.
</p>
<p>
    <a href="/about.html">More ...</a>
</p>

                </div>
                <div id="sbox2">
                    <h2>Recent</h2>
                    <ul class="list-unstyled">
                            <li><a href="/posts/Swerve-drive-motor-limitations">Swerve drive - Motor limitations</a></li>
                            <li><a href="/posts/Swerve-drive-ros2-nav">Swerve drive - Using Nav2</a></li>
                            <li><a href="/posts/Robotics-making-urdf-models">Robotics - Making URDF models</a></li>
                            <li><a href="/posts/Swerve-motion-profiles">Swerve drive - Motion profiles</a></li>
                            <li><a href="/posts/Swerve-drive-control-animations">Swerve drive - Movement animations</a></li>
                            <li><a href="/posts/Swerve-drive-body-focussed-control">Swerve drive - Better movement by controlling the body motions</a></li>
                            <li><a href="/posts/Swerve-drive-kinematics-verification">Swerve drive - Verification of the kinematics solution</a></li>
                            <li><a href="/posts/Swerve-drive-kinematics-simulation">Swerve drive - Kinematics simulation</a></li>
                            <li><a href="/posts/Swerve-drive-introduction">Swerve drive - Moving a robot in all directions, mostly</a></li>
                            <li><a href="/posts/Robotics-fixing-scuttles-encoder">Starting robotics - Fixing the wheel encoders</a></li>
                    </ul>
                </div>
                <div id="sbox3">
                    <h2>Tags</h2>
                    <div>
                        <ul class="list-unstyled">
                                <li>
                                    <a role="button" href="/tags/Robotics" class="btn btn-default btn-sm"> Robotics (17)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Sherlock" class="btn btn-default btn-sm"> Sherlock (13)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/nBuildKit" class="btn btn-default btn-sm"> nBuildKit (12)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Software-development-pipeline" class="btn btn-default btn-sm"> Software development pipeline (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Delivering-software" class="btn btn-default btn-sm"> Delivering software (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/DevOps" class="btn btn-default btn-sm"> DevOps (11)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/PG2" class="btn btn-default btn-sm"> PG2 (9)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Paragliding" class="btn btn-default btn-sm"> Paragliding (9)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Zinger" class="btn btn-default btn-sm"> Zinger (8)</a>
                                </li>
                                <li>
                                    <a role="button" href="/tags/Omnidirectional" class="btn btn-default btn-sm"> Omnidirectional (8)</a>
                                </li>
                        </ul>
                    </div>
                    <br />
                    <ul class="pager">
                        <li class="next">
                            <a href="/tags">View All Tags &rarr;</a>
                        </li>
                    </ul>
                </div>
            </div>

            <div id="content">

<div id="post">
    <div id="post-header">
        <!--
    Model is: Tuple<IDocument, IDocument>.
    The first one is the current document that is being rendered, the second one is the one for which the post header should be rendered.
-->


<h2>
Swerve drive - Better movement by controlling the body motions</h2>
<div id="post-meta">
    <div class="meta-date">
Friday, June 9, 2023
 |             Posted in     </div>
    <div class="meta-tags">
                        <a id="post-category" role="button" href="/tags/Kinematics" class="btn btn-default btn-xs tag-no-wrap">Kinematics</a>
                        <a id="post-category" role="button" href="/tags/Omnidirectional" class="btn btn-default btn-xs tag-no-wrap">Omnidirectional</a>
                        <a id="post-category" role="button" href="/tags/Robotics" class="btn btn-default btn-xs tag-no-wrap">Robotics</a>
                        <a id="post-category" role="button" href="/tags/Swerve" class="btn btn-default btn-xs tag-no-wrap">Swerve</a>
                        <a id="post-category" role="button" href="/tags/Zinger" class="btn btn-default btn-xs tag-no-wrap">Zinger</a>
    </div>
</div>

    </div>

    <div id="post-content">
        <p>In my <a href="/posts/Swerve-drive-kinematics-simulation">first attempt</a> to model a swerve drive I controlled
the movement of the robot by directly providing commands to the individual drive modules, i.e. by
controlling the steering angle and the wheel velocity of each of the four drive modules. Additionally
I assumed that the transition from one state (steering angle, wheel velocity) to another state would
follow a linear profile. An example of this can be seen in the graphs below. The bottom left graph shows
the linear change in steering angle for the four drive modules. It should be noted that a linear
profile isn't very realistic as this requires the motors to be capable of instant changes in velocity
and acceleration. However making this assumption keeps the calculations simple. At a later stage I
will be encoding different movement profiles amongst which a low
<a href="https://en.wikipedia.org/wiki/Jerk_(physics)">jerk</a> profile for smooth movements.</p>
<figure style="float:middle">
  <a href="/assets/images/robotics/swerve/swerve_sim_45_linear_to_inplace_rotation.png" target="_blank">
    <img
        alt="45 degree linear track to in-place rotation with a module-first control algorithm"
        src="/assets/images/robotics/swerve/swerve_sim_45_linear_to_inplace_rotation.png"
        width="840"
        height="368"/>
  </a>
  <figcaption>
    Simulation data for a 45 degree linear track that transitions to an in-place rotation with a
    module-first control algorithm.
  </figcaption>
</figure>
<p>The benefit of controlling the robot by directly controlling the drive modules is that the control
algorithm is very simple and all movement patterns are possible. For instance it is possible to make
all the wheels change steering angle without moving the robot body, something which is not possible
with indirect control methods.</p>
<p>However there are also a number of drawbacks. The main one is that
for a swerve drive to be efficient the motions of the different drive modules need to be synchronized.
That means that all the drive modules needs to be controlled so that none of the wheels slip along
the surface. For simple linear or rotational movements of the robot body this is easy to achieve but
for complicated movements this is much more difficult. An example is shown in image above which
describes the behaviour of the robot as it moves linearly at a 45 degree angle and then transitions
to an in-place rotation around the robot centre axis. The bottom right graph shows the
<a href="https://en.wikipedia.org/wiki/Instant_centre_of_rotation">instantaneous centre of rotation</a> calculated
for different combinations of two wheels. In a synchronised motion all wheels should point to the same
instantaneous centre of rotation at any given moment. If the ICR's for the different wheel pairs are
in different locations then one or more of the wheels is out of sync and likely slipping along
the ground. The graph clearly shows that in this case the drive modules are not synchronized thus
causing wheel slip.</p>
<p>One way to improve the synchronization between the drive modules is apply the movement control at
an indirect level, for instance on the robot body, and then to work out from there what the drive modules
should be doing at any that given point in time along the transition profile.</p>
<p>As with the previous approach I will use a
<a href="https://github.com/pvandervelde/basic-swerve-sim/blob/103b321c471ced6c8865680d1e550ab4f5893526/swerve_controller/profile.py#L47">linear profile</a>
to determine the transitions between different body states. Then the transition for the
<a href="https://github.com/pvandervelde/basic-swerve-sim/blob/103b321c471ced6c8865680d1e550ab4f5893526/swerve_controller/trajectory.py#L42">body velocities (x-velocity, y-velocity, and rotational velocity)</a>
can be determined from the start state to the end state. Once it is known what
the body motion looks like I can calculate the
<a href="https://github.com/pvandervelde/basic-swerve-sim/blob/103b321c471ced6c8865680d1e550ab4f5893526/swerve_controller/multi_wheel_steering_controller.py#L100">states for the drive modules</a>
from the body state for all given states in the transition profile.</p>
<figure style="float:middle">
  <a href="/assets/images/robotics/swerve/serve_sim_module_flip_steering_angle.png" target="_blank">
    <img
        alt="Drive module steering angle flip"
        src="/assets/images/robotics/swerve/serve_sim_module_flip_steering_angle.png"
        width="840"
        height="368"/>
  </a>
  <figcaption>
    Drive module steering angle flip.
  </figcaption>
</figure>
<p>One issue with this approach is that every body state can be achieved by two different module states,
one with the wheel moving &lsquo;forward&rsquo; and one with the wheel moving 'backward'. Initially the simulation
was hard-coded to always select the &lsquo;forward&rsquo; moving state. However this leads to situations where
the steering angle is flipped 180 degrees very rapidly. This is shown in the figure where the yellow
line switches from 45 degrees (or 0.78 radians) to 225 degrees (or 3.9 radians) in two time steps, or
0.02 seconds. In real life this change in steering angle would likely not be possible because the
steering angle motor would not be capable of delivering the enormous velocities and accelerations
necessary to achieve this change.</p>
<p>To resolve this issue the simulation calculated the difference in rotation and velocity between the
current point in time and the previous point in time along the transition profile, for both the
forward and backward motions. Then <a href="https://github.com/pvandervelde/basic-swerve-sim/blob/103b321c471ced6c8865680d1e550ab4f5893526/swerve_controller/multi_wheel_steering_controller.py#L140">general rule</a>
is to pick the smallest change in both rotation and velocity of the drive module. If that isn't
possible then we pick the one with the smallest rotation difference for no real reason other than we
have to pick something. In future work a more thorough algorithm will be implemented.</p>
<p>With all that code in place the simulation delivers a much smoother result for the transition from
a 45 degree linear motion into a in-place rotation. The ICR path for all the wheel pairs is
following a single path indicating that all the drive modules are all synchronised during the
movement transition.</p>
<figure style="float:middle">
  <a href="/assets/images/robotics/swerve/swerve_sim_body_first_45_linear_to_inplace_rotation.png" target="_blank">
    <img
        alt="45 degree linear track to in-place rotation with a body first control algorithm"
        src="/assets/images/robotics/swerve/swerve_sim_body_first_45_linear_to_inplace_rotation.png"
        width="840"
        height="368"/>
  </a>
  <figcaption>
    Simulation data for a 45 degree linear track that transitions to an in-place rotation with a
    body-first control algorithm.
  </figcaption>
</figure>
<p>The body oriented control approach ensures synchronisation of the drive modules while allowing
nearly all the different motions a swerve drive can make. The only motions not possible are those
that involve drive module steering angle changes only.</p>
<p>The next improvement will be to replace the linear interpolation between the start state and the
desired end state with a control approach that will provide
<a href="https://en.wikipedia.org/wiki/Jerk_(physics)#In_motion_control">smooth transitions</a> for velocity and
accelerations. This will make the motions of the robot less jerky and thus less likely to damage
parts while also providing a smoother ride for the payload.</p>
<h4>Edits</h4>
<ul>
<li>July 4th 2023: Changed the term <code>control trajectory</code> to <code>control profile</code> because the term
<code>trajectory</code> is generally reserved for path planning situations.</li>
<li>July 4th 2023: Changed the term <code>ICR trajectory</code> to <code>ICR path</code> because the the ICR does not
follow a trajectory, it follows a path.</li>
</ul>

    </div>

    <div id="post-footer">
        <div>
    <div class="navlinks">
                <a href="/posts/Swerve-drive-kinematics-verification" title="Previous Post: Swerve drive - Verification of the kinematics solution" class="navlinks-prev">« Swerve drive - Verification of the kinematics solution</a>
                <a href="/posts/Swerve-drive-control-animations" title="Next Post: Swerve drive - Movement animations" class="navlinks-next">Swerve drive - Movement animations »</a>
    </div>
</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mindvortex'; // required: replace example with your forum shortname
    var disqus_identifier = 'Swerve-drive-body-focussed-control';
    var disqus_title = 'Swerve drive - Better movement by controlling the body motions';
    var disqus_url = 'https://www.petrikvandervelde.nl/posts/Swerve-drive-body-focussed-control';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>
</div>







            </div>
        </div>

        <footer>
            <div id="footer" class="container">
    <div id="fbox1">
        <h2>Related</h2>
        <ul>
            <li><a href="https://github.com/pvandervelde"><i class="fa fa-github"></i> GitHub</a></li>
            <li><a href="https://www.linkedin.com/profile/view?id=33950311"><i class="fa fa-linkedin"></i> LinkedIn</a></li>
            <li><a href="https://stackoverflow.com/users/539846/petrik"><i class="fa fa-stack-overflow"></i> StackOverflow</a></li>
            <li><a href="https://careers.stackoverflow.com/pvandervelde"><i class="fa fa-stack-overflow"></i> StackOverflow Careers</a></li>
            <li><a href="https://profile.codersrank.io/user/pvandervelde">CodersRank</a></li>
        </ul>
    </div>
    <div id="fbox2">
        <h2 id="copyright">Copyright</h2>
        <p>Copyright (c) 2024 <a href="/">Petrik van der Velde</a>. All rights reserved.</p>

        <h2 id="disclaimer">Disclaimer</h2>
        <p>The opinions expressed herein are my own personal opinions and do not represent my employer's view in any way.</p>
    </div>
    <div id="fbox3">
        <h2 id="media">Media</h2>
        <p><a href="/feed.atom"><img src="/assets/images/feed.png" alt="Atom feed"></a></p>
    </div>
</div>
<div id="copyright" class="container">
    <div>
        <p>
            Generated by <a href="https://wyam.io">Wyam</a> on Thu, 22 Feb 2024 09:15:58 GMT

 from commit <a href="https://github.com/pvandervelde/mindvortex/tree/8f0cb31f2b7d5b06ebc24f0520faedafad19887e">8f0cb31f2b7d5b06ebc24f0520faedafad19887e</a> at version 3.20.0.        </p>
    </div>

    <p>
        Site design based on the <a href="https://www.freecsstemplates.org/previews/opentools/">Open Tools</a> design
        by <a href="https://www.freecsstemplates.org">FreeCSSTemplates.org</a>.
    </p>
    <p>
        Feed icon by <a href="https://www.icojam.com/">Icojam</a> and Favicon by
        <a href="https://www.flaticon.com/free-icon/twister-sky-wind_12318" title="Yannick">Yannick</a>
        from <a href="https://www.flaticon.com" title="Flaticon">www.flaticon.com</a>
    </p>
</div>

        </footer>
    </body>
</html>
